import oo from"node:http";import to from"cors";import tt from"express";import{Router as rr}from"express";import C from"zod";var Kt=1,Lt=6,Wt=C.object({page:C.coerce.number().min(1).default(Kt),limit:C.coerce.number().min(1).default(Lt),title:C.string(),description:C.string(),orderBy:C.union([C.enum(["asc","desc"]),C.literal("")]).optional().transform(o=>o===""?void 0:o)}),X=class{constructor(e){this.certificationRepository=e}async handle(e,t){try{let r=Wt.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,description:e.query.description,orderBy:e.query.order_by});if(!r.success)return t.status(400).json({errors:C.prettifyError(r.error)});let{title:i,description:s,limit:a,orderBy:n="desc",page:m}=r.data,p=m*a-a,u=e.user.id,[d,S]=await Promise.all([this.certificationRepository.findByUserId({userId:u,pagination:{offset:p,limit:a},filter:{title:i,description:s,orderBy:n}}),this.certificationRepository.count({filter:{title:i,description:s,userId:u}})]),M=Math.max(Math.ceil(S/a),1);return t.status(200).json({page:m,totalPages:M,offset:p,limit:a,certifications:d})}catch(r){return console.log(r),r instanceof Error?t.status(400).json({message:r.message}):t.status(400).json({message:"Erro ao buscar certifica\xE7\xF5es."})}}};var Y=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=e.user.id,i=await this.userRepository.findById(r);return i?t.status(200).json(i):t.status(404).json({message:"Usu\xE1rio n\xE3o encontrado."})}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};import b from"zod";var Gt=1,Zt=7,Jt=b.object({page:b.coerce.number().min(1).default(Gt),limit:b.coerce.number().min(1).default(Zt),title:b.string().optional(),content:b.string().optional(),orderBy:b.union([b.enum(["asc","desc"]),b.literal("")]).optional().transform(o=>o===""?void 0:o)}),$=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Jt.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,orderBy:e.query.order_by});if(!r.success)return t.status(400).json({errors:b.prettifyError(r.error)});let{page:i,limit:s,content:a,orderBy:n,title:m}=r.data,p=s*i-s,u=e.user.id,[d,S]=await Promise.all([this.newsRepository.findByAuthorId({authorId:u,pagination:{offset:p,limit:s},filter:{orderBy:n,title:m,content:a}}),this.newsRepository.count({filter:{authorId:u,content:a,title:m}})]),M=Math.ceil(S/s);t.status(200).json({page:i,totalPages:M,offset:p,limit:s,news:d})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import V from"zod";var Xt=V.object({password:V.string(),email:V.email()}),ee=class{constructor(e,t,r){this.userRepository=e;this.bcrypt=t;this.jwtService=r}async handle(e,t){try{let r=Xt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:V.prettifyError(r.error)});let{email:i,password:s}=r.data,a=await this.userRepository.findByEmail(i);if(!a)return t.status(401).json({message:"Usu\xE1rio n\xE3o existe."});if(!await this.bcrypt.compare({password:s,hashedPassword:a.passwordHash}))return t.status(401).json({message:"Senha inv\xE1lida."});let{id:m,role:p}=a,u=this.jwtService.sign({id:m,role:p,email:i});return t.status(200).json({token:u})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import Q from"zod";var te=8,Yt=Q.object({name:Q.string("Nome \xE9 obrigat\xF3rio.").min(1,"Nome \xE9 obrigat\xF3rio."),email:Q.email("E-mail inv\xE1lido.").min(1,"E-mail \xE9 obrigat\xF3rio."),password:Q.string("A senha \xE9 obrigat\xF3ria.").min(te,`A senha deve ter pelo menos ${te} caracteres.`),confirmPassword:Q.string("A senha \xE9 obrigat\xF3ria.").min(te,`A senha deve ter pelo menos ${te} caracteres.`)}).refine(o=>o.password===o.confirmPassword,{message:"As senhas n\xE3o coincidem.",path:["confirmPassword"]}),re=class{constructor(e,t){this.userRepository=e;this.bcrypt=t}async handle(e,t){try{let r=Yt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:Q.prettifyError(r.error)});let{email:i,name:s,password:a}=r.data;if(await this.userRepository.findByEmail(i))return t.status(400).json({message:"Usu\xE1rio j\xE1 existe."});let m=await this.bcrypt.hash(a);return await this.userRepository.create({name:s,emailAddress:i,passwordHash:m}),t.status(201).json({message:"Usu\xE1rio criado com sucesso."})}catch(r){if(r instanceof Error)return t.status(400).json({message:r.message})}}};import{PrismaClient as $t}from"@prisma/client";var f=new $t({log:["query"]});var oe=class{constructor(e){this.prisma=e}async register({userId:e,title:t,description:r,certificationUrl:i}){await this.prisma.certification.create({data:{title:t,description:r,certificationUrl:i,user:{connect:{id:e}}}})}async find({pagination:{limit:e,offset:t},filter:{description:r,orderBy:i,title:s}}){let a={};s&&(a.title={contains:s,mode:"insensitive"});let n=[];return r&&n.push({description:{contains:r,mode:"insensitive"}}),n.length>0&&(a.OR=n),await this.prisma.certification.findMany({where:a,include:{user:{omit:{passwordHash:!0}}},skip:t,take:e,orderBy:{updatedAt:i}})}async findById(e){return await this.prisma.certification.findFirst({where:{id:e}})}async findByUserId({pagination:{limit:e,offset:t},filter:{description:r,orderBy:i,title:s},userId:a}){let n={userId:a},m=[];return s&&m.push({title:{contains:s,mode:"insensitive"}}),r&&m.push({description:{contains:r,mode:"insensitive"}}),m.length>0&&(n.OR=m),await this.prisma.certification.findMany({where:n,include:{user:{omit:{passwordHash:!0}}},skip:t,take:e,orderBy:{updatedAt:i}})}async update({id:e,...t}){await this.prisma.certification.update({where:{id:e},data:t})}async deleteById(e){await this.prisma.certification.delete({where:{id:e}})}async count({filter:{description:e,title:t,userId:r}}){let i={};t&&(i.title={contains:t,mode:"insensitive"});let s=[];return e&&s.push({description:{contains:e,mode:"insensitive"}}),r&&s.push({userId:r}),s.length>0&&(i.OR=s),await this.prisma.certification.count({where:i})}};function F(){return new oe(f)}var se=class{constructor(e){this.prisma=e}async create({authorId:e,...t}){return await this.prisma.news.create({data:{...t,author:{connect:{id:e}}}})}async find({pagination:{offset:e,limit:t},filter:{authorId:r,content:i,title:s,orderBy:a="desc"}}){let n={};r&&(n.authorId={contains:r,mode:"insensitive"});let m=[];return s&&m.push({title:{contains:s,mode:"insensitive"}}),i&&m.push({content:{contains:i,mode:"insensitive"}}),m.length>0&&(n.OR=m),await this.prisma.news.findMany({where:n,omit:{authorId:!0},include:{author:!0},orderBy:{updatedAt:a},skip:e,take:t})}async findById(e){return await this.prisma.news.findUnique({where:{id:e},omit:{authorId:!0},include:{author:!0}})}async findByAuthorId({authorId:e,pagination:{offset:t,limit:r},filter:{orderBy:i="desc",content:s,title:a}}){let n={authorId:e},m=[];return a&&m.push({title:{contains:a,mode:"insensitive"}}),s&&m.push({content:{contains:s,mode:"insensitive"}}),m.length>0&&(n.OR=m),await this.prisma.news.findMany({omit:{authorId:!0},where:n,orderBy:{updatedAt:i},skip:t,take:r})}async update(e){return await this.prisma.news.update({where:{id:e.id},data:{title:e.title,content:e.content,imageUrl:e.imageUrl}})}async delete(e){await this.prisma.news.delete({where:{id:e}})}async count({filter:{authorId:e,content:t,title:r}}){let i={};e&&(i.authorId={contains:e,mode:"insensitive"});let s=[];return r&&s.push({title:{contains:r,mode:"insensitive"}}),t&&s.push({content:{contains:t,mode:"insensitive"}}),s.length>0&&(i.OR=s),await this.prisma.news.count({where:i})}};function A(){return new se(f)}var ie=class{constructor(e){this.prisma=e}async create(e){await this.prisma.user.create({data:e})}async update(e){await this.prisma.user.update({where:{id:e.id},data:e})}async deleteById(e){await this.prisma.user.delete({where:{id:e}})}async find(){return await this.prisma.user.findMany({omit:{passwordHash:!0}})}async findByEmail(e){return await this.prisma.user.findFirst({where:{emailAddress:e}})}async findById(e){return await this.prisma.user.findFirst({where:{id:e}})}};function y(){return new ie(f)}import{compare as Vt,hash as er}from"bcryptjs";var ae=class{constructor(e,t){this.hashFn=e;this.compareFn=t}async hash(e){return await this.hashFn(e,6)}async compare({password:e,hashedPassword:t}){return await this.compareFn(e,t)}};function Qe(){return new ae(er,Vt)}import rt from"jsonwebtoken";import R from"zod";var tr=R.object({JWT_SECRET:R.string(),FIREBASE_BUCKET:R.string(),FIREBASE_CLIENT_EMAIL:R.string(),FIREBASE_PRIVATE_KEY:R.string(),FIREBASE_PROJECT_ID:R.string(),FIREBASE_TYPE:R.string(),FIREBASE_PRIVATE_KEY_ID:R.string(),FIREBASE_CLIENT_ID:R.string(),FIREBASE_AUTH_URI:R.string(),FIREBASE_TOKEN_URI:R.string(),FIREBASE_AUTH_PROVIDER_X509_CERT_URL:R.string(),FIREBASE_CLIENT_X509_CERT_URL:R.string()}),l=tr.parse(process.env);var ne=class{constructor(e,t){this.signFn=e;this.verifyFn=t}sign(e){try{return this.signFn(e,l.JWT_SECRET,{expiresIn:"3d",subject:e.id})}catch{return null}}verify(e){try{return this.verifyFn(e,l.JWT_SECRET)}catch{return null}}};function me(){return new ne(rt.sign,rt.verify)}function ot(){return{signUpController:new re(y(),Qe())}}function st(){return{signInController:new ee(y(),Qe(),me())}}function it(){return{findAuthenticatedUserController:new Y(y())}}function at(){return{findAuthenticatedUserController:new $(A())}}function nt(){return{findAuthenticatedUserCertificationsController:new X(F())}}var pe=class{constructor(e){this.jwtService=e}authenticated(e,t,r){let i=e.headers.authorization;if(!i)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let s=this.jwtService.verify(i);if(!s)return t.status(401).json({message:"Token inv\xE1lido."});e.user=s,r()}catch(s){if(console.log(s),s instanceof Error)return t.status(401).json({message:s.message})}}isAdmin(e,t,r){let i=e.headers.authorization;if(!i)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let s=this.jwtService.verify(i);if(!s)return t.status(401).json({message:"Token inv\xE1lido."});if(s.role!=="ADMIN")return t.status(401).json({message:"\xC9 necess\xE1rio ter permiss\xF5es de administrador."});r()}catch(s){if(console.log(s),s instanceof Error)return t.status(401).json({message:s.message})}}};function h(){return{authMiddleware:new pe(me())}}var x=rr(),{signUpController:or}=ot(),{signInController:sr}=st(),{authMiddleware:ce}=h();x.post("/sign-up",async(o,e)=>{await or.handle(o,e)});x.post("/sign-in",async(o,e)=>{await sr.handle(o,e)});x.get("/user",(o,e,t)=>{ce.authenticated(o,e,t)},async(o,e)=>{let{findAuthenticatedUserController:t}=it();await t.handle(o,e)});x.get("/user/news",(o,e,t)=>{ce.authenticated(o,e,t)},async(o,e)=>{let{findAuthenticatedUserController:t}=at();await t.handle(o,e)});x.get("/admin",(o,e,t)=>{ce.isAdmin(o,e,t)},(o,e)=>{e.status(200).json({success:!0})});x.get("/certifications",(o,e,t)=>{ce.authenticated(o,e,t)},async(o,e)=>{let{findAuthenticatedUserCertificationsController:t}=nt();await t.handle(o,e)});import{Router as hr}from"express";import He from"zod";var ir=He.object({id:He.string()}),ue=class{constructor(e,t){this.certificationRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=ir.safeParse({id:e.params.certification_id});if(!r.success)return t.status(400).json({message:He.prettifyError(r.error)});let i=await this.certificationRepository.findById(r.data.id);return i?(await Promise.all([this.certificationRepository.deleteById(i.id),this.firebaseStorageService.deleteFile({fileUrl:i.certificationUrl})]),t.status(200).json({message:"Certifica\xE7\xE3o deletada com sucesso!"})):t.status(404).json({message:"A certifica\xE7\xE3o n\xE3o existe."})}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};import ze from"zod";var ar=ze.object({certificationId:ze.uuid()}),de=class{constructor(e){this.certificationRepository=e}async handle(e,t){try{let r=ar.safeParse({certificationId:e.params.certification_id});if(!r.success)return t.status(400).json({message:ze.prettifyError(r.error)});let i=await this.certificationRepository.findById(r.data.certificationId);return i?t.status(200).json(i):t.status(404).json({message:"Certificado n\xE3o encontrado."})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import B from"zod";var nr=1,mr=6,pr=B.object({page:B.coerce.number().min(1).default(nr),limit:B.coerce.number().min(1).default(mr),title:B.string().optional(),description:B.string().optional(),orderBy:B.union([B.enum(["asc","desc"]),B.literal("")]).optional().transform(o=>o===""?void 0:o)}),le=class{constructor(e){this.certificationRepository=e}async handle(e,t){try{let r=pr.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,description:e.query.description,authorId:e.query.author_id,orderBy:e.query.order_by});if(!r.success)return t.status(400).json({errors:B.prettifyError(r.error)});let{description:i,limit:s,orderBy:a="desc",page:n,title:m}=r.data,p=n*s-s,[u,d]=await Promise.all([this.certificationRepository.find({pagination:{offset:p,limit:s},filter:{title:m,description:i,orderBy:a}}),this.certificationRepository.count({filter:{title:m,description:i}})]),S=Math.max(Math.ceil(d/s),1);return t.status(200).json({page:n,totalPages:S,offset:p,limit:s,certifications:u})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import H from"zod";var w={NEWS:"images/news",USER:"images/user",CERTIFICATION:"documents/certifications"};var cr=H.object({userId:H.uuid(),title:H.string().min(1,"T\xEDtulo \xE9 obrigat\xF3rio."),description:H.string().min(1,"Descri\xE7\xE3o \xE9 obrigat\xF3ria."),certification:H.any().refine(o=>o&&typeof o=="object"&&o.size>0,"Arquivo do certificado \xE9 obrigat\xF3rio")}),fe=class{constructor(e,t,r){this.userRepository=e;this.certificationRepository=t;this.firebaseStorageService=r}async handle(e,t){try{let r=cr.safeParse({...e.body,userId:e.params.user_id,certification:e.file});if(!r.success)return t.status(400).json({errors:H.prettifyError(r.error)});let{userId:i,title:s,description:a,certification:n}=r.data;if(!await this.userRepository.findById(i))return t.status(400).json({message:"O usu\xE1rio n\xE3o existe."});let p=await this.firebaseStorageService.uploadFile({file:n,id:i,folder:w.CERTIFICATION});return await this.certificationRepository.register({userId:i,title:s,description:a,certificationUrl:p}),t.status(201).json({message:"Certifica\xE7\xE3o cadastrada com sucesso."})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import z from"zod";var ur=z.object({id:z.uuid(),title:z.string().min(1,"T\xEDtulo \xE9 obrigat\xF3rio."),description:z.string().min(1,"Descri\xE7\xE3o \xE9 obrigat\xF3ria."),certification:z.any().refine(o=>o.size===0||o.size>0,"Arquivo do certificado \xE9 inv\xE1lido").optional()}),ye=class{constructor(e,t){this.certificationRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=ur.safeParse({...e.body,id:e.params.certification_id,certification:e.file});if(!r.success)return t.status(400).json({errors:z.prettifyError(r.error)});let{certification:i,id:s,...a}=r.data,n=await this.certificationRepository.findById(s);if(!n)return t.status(400).json({message:"A certifica\xE7\xE3o n\xE3o existe"});let m=n.certificationUrl;return i.size>0&&(m=await this.firebaseStorageService.updateFile({file:i,id:n.userId,folder:w.CERTIFICATION,fileUrl:n.certificationUrl})),await this.certificationRepository.update({...a,id:s,certificationUrl:m}),t.status(200).json({message:"Certifica\xE7\xE3o atualizada com sucesso."})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import{getStorage as lr}from"firebase-admin/storage";import{config as dr}from"dotenv";import mt from"firebase-admin";dr();var Ke=mt.initializeApp({credential:mt.credential.cert({clientEmail:l.FIREBASE_CLIENT_EMAIL,privateKey:l.FIREBASE_PRIVATE_KEY,projectId:l.FIREBASE_PROJECT_ID,type:l.FIREBASE_TYPE,privateKeyId:l.FIREBASE_PRIVATE_KEY_ID,clientId:l.FIREBASE_CLIENT_ID,authUri:l.FIREBASE_AUTH_URI,tokenUri:l.FIREBASE_TOKEN_URI,authProviderX509CertUrl:l.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,clientX509CertUrl:l.FIREBASE_CLIENT_X509_CERT_URL}),storageBucket:l.FIREBASE_BUCKET});Ke.name?console.log("\u{1F525} Firebase conectado com sucesso!"):console.error("\u274C Erro ao se conectar ao Firebase.");var fr=lr(Ke),pt=fr.bucket(l.FIREBASE_BUCKET);import{randomUUID as yr}from"node:crypto";var Rr=/https:\/\/storage\.googleapis\.com\/[^/]+\/(.+)$/,Re=class{constructor(e){this.bucket=e}async uploadFile({file:e,folder:t,id:r}){let i=`${yr()}-${e?.originalname}`,s=this.bucket.file(`${t}/${r}/${i}`);return await new Promise((a,n)=>{let m=s.createWriteStream({metadata:{contentType:e?.mimetype}});m.on("error",p=>{console.log(p),n(p)}),m.on("finish",async()=>{try{await s.makePublic();let p=`https://storage.googleapis.com/${this.bucket.name}/${s.name}`;a(p)}catch(p){console.error(p),n(p)}}),m.end(e.buffer)})}async updateFile({file:e,id:t,fileUrl:r,folder:i}){try{let s=this.getPath(r);if(!s)throw new Error("Arquivo n\xE3o encontrado.");let[a,n]=await Promise.all([this.bucket.file(s).delete(),this.uploadFile({file:e,id:t,folder:i})]);return n}catch(s){throw console.error(s),new Error("Erro ao atualizar o arquivo.")}}async deleteFile({fileUrl:e}){let t=this.getPath(e);if(!t)throw new Error("Arquivo n\xE3o encontrado.");try{await this.bucket.file(t).delete()}catch(r){throw console.error(r),new Error("Erro ao deletar o arquivo.")}}getPath(e){let t=e.match(Rr);return t?t[1]:null}};function E(){return new Re(pt)}function ct(){return{registerCertificationController:new fe(y(),F(),E())}}function ut(){return{findCertificationsController:new le(F())}}function dt(){return{findCertificationByIdController:new de(F())}}function lt(){return{updateCertificationController:new ye(F(),E())}}function ft(){return{deleteCertificationController:new ue(F(),E())}}import yt from"multer";var j=yt({storage:yt.memoryStorage()});var O=hr(),{authMiddleware:Z}=h();O.post("/:user_id",(o,e,t)=>{Z.isAdmin(o,e,t)},j.single("certification"),async(o,e)=>{let{registerCertificationController:t}=ct();await t.handle(o,e)});O.get("/",(o,e,t)=>{Z.isAdmin(o,e,t)},async(o,e)=>{let{findCertificationsController:t}=ut();await t.handle(o,e)});O.get("/:certification_id",(o,e,t)=>{Z.isAdmin(o,e,t)},async(o,e)=>{let{findCertificationByIdController:t}=dt();await t.handle(o,e)});O.put("/:certification_id",(o,e,t)=>{Z.isAdmin(o,e,t)},j.single("certification"),async(o,e)=>{let{updateCertificationController:t}=lt();await t.handle(o,e)});O.delete("/:certification_id",(o,e,t)=>{Z.isAdmin(o,e,t)},async(o,e)=>{let{deleteCertificationController:t}=ft();await t.handle(o,e)});import{Router as gr}from"express";var Le=gr();Le.get("/",(o,e)=>{e.status(200).json({message:"Rede CT"})});import{Router as Nr}from"express";import J from"zod";var wr=5,Rt=1024,Er=Rt*Rt,Ir=wr*Er,Tr=J.object({title:J.string().min(1),content:J.string().min(1),image:J.any().refine(o=>!o||typeof o=="object"&&typeof o.mimetype=="string"&&o.mimetype.startsWith("image/")&&typeof o.size=="number"&&o.size<=Ir,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),he=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Tr.safeParse({...e.body,image:e.file});if(!r.success)return t.status(400).json({errors:J.prettifyError(r.error)});let{title:i,content:s,image:a}=r.data,n=e.user.id,m=await this.firebaseStorageService.uploadFile({file:a,folder:w.NEWS,id:n}),p=await this.newsRepository.create({title:i,content:s,authorId:n,imageUrl:m});t.status(201).json(p)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import We from"zod";var Ur=We.object({id:We.string()}),ge=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Ur.safeParse(e.params);if(!r.success)return t.status(400).json({errors:We.prettifyError(r.error)});let{id:i}=r.data,s=e.user.id,a=await this.newsRepository.findById(i);if(!a)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});if(a.author.id!==s)return t.status(401).json({message:"Sem permiss\xE3o."});await Promise.all([this.newsRepository.delete(i),this.firebaseStorageService.deleteFile({fileUrl:a.imageUrl})]),t.status(200).json({message:"Not\xEDcia deletada com sucesso."})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import I from"zod";var Sr=1,Cr=7,br=I.object({page:I.coerce.number().min(1).default(Sr),limit:I.coerce.number().min(1).default(Cr),authorId:I.string(),title:I.string().optional(),content:I.string().optional(),orderBy:I.union([I.enum(["asc","desc"]),I.literal("")]).optional().transform(o=>o===""?void 0:o)}),we=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=br.safeParse({page:e.query.page,limit:e.query.limit,author_id:e.params.author_id,title:e.query.title,content:e.query.content,orderBy:e.query.order_by});if(!r.success)return t.status(400).json({errors:I.prettifyError(r.error)});let{page:i,limit:s,authorId:a,content:n,orderBy:m,title:p}=r.data,u=s*i-s,[d,S]=await Promise.all([this.newsRepository.findByAuthorId({authorId:a,pagination:{offset:u,limit:s},filter:{orderBy:m,title:p,content:n}}),this.newsRepository.count({filter:{authorId:a,content:n,title:p}})]),M=Math.max(Math.ceil(S/s),1);t.status(200).json({page:i,totalPages:M,offset:u,limit:s,news:d})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Ge from"zod";var Ar=Ge.object({id:Ge.string()}),Ee=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Ar.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ge.prettifyError(r.error)});let{id:i}=r.data,s=await this.newsRepository.findById(i);t.status(200).json(s)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import T from"zod";var Br=1,_r=9,vr=T.object({page:T.coerce.number().min(1).default(Br),limit:T.coerce.number().min(1).default(_r),title:T.string().optional(),content:T.string().optional(),authorId:T.string().optional(),orderBy:T.union([T.enum(["asc","desc"]),T.literal("")]).optional().transform(o=>o===""?void 0:o)}),Ie=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=vr.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,authorId:e.query.author_id,orderBy:e.query.order_by});if(!r.success)return t.status(400).json({errors:T.prettifyError(r.error)});let{page:i,limit:s,authorId:a,content:n,orderBy:m,title:p}=r.data,u=s*i-s,[d,S]=await Promise.all([this.newsRepository.find({pagination:{offset:u,limit:s},filter:{authorId:a,content:n,title:p,orderBy:m}}),this.newsRepository.count({filter:{title:p,content:n,authorId:a}})]),M=Math.max(Math.ceil(S/s),1);t.status(200).json({page:i,totalPages:M,offset:u,limit:s,news:d})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import K from"zod";var Fr=5,ht=1024,xr=ht*ht,jr=Fr*xr,Dr=K.object({id:K.string(),title:K.string().min(1),content:K.string().min(1),image:K.any().optional().refine(o=>!o||typeof o=="object"&&typeof o.mimetype=="string"&&o.mimetype.startsWith("image/")&&typeof o.size=="number"&&o.size<=jr,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),Te=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Dr.safeParse({id:e.params.id,title:e.body.title,content:e.body.content,image:e.file});if(!r.success)return t.status(400).json({errors:K.prettifyError(r.error)});let{id:i,title:s,content:a,image:n}=r.data,m=await this.newsRepository.findById(i);if(!m)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});let p=e.user.id;if(m.author.id!==p)return t.status(401).json({message:"Sem permiss\xE3o."});let u=m.imageUrl||"";n&&m.imageUrl&&(u=await this.firebaseStorageService.updateFile({file:n,folder:w.NEWS,id:i,fileUrl:m.imageUrl}));let d=await this.newsRepository.update({id:i,title:s,content:a,imageUrl:u});t.status(200).json(d)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};function gt(){return{createNewsController:new he(A(),E())}}function wt(){return{findAllNewsController:new Ie(A())}}function Et(){return{findNewsByIdController:new Ee(A())}}function It(){return{findNewsByAuthorIdController:new we(A())}}function Tt(){return{updateNewsController:new Te(A(),E())}}function Ut(){return{deleteNewsController:new ge(A(),E())}}var D=Nr(),{authMiddleware:Ze}=h();D.post("/",(o,e,t)=>{Ze.authenticated(o,e,t)},j.single("image"),async(o,e)=>{let{createNewsController:t}=gt();await t.handle(o,e)});D.get("/",async(o,e)=>{let{findAllNewsController:t}=wt();await t.handle(o,e)});D.get("/:id",async(o,e)=>{let{findNewsByIdController:t}=Et();await t.handle(o,e)});D.get("/author/:authorId",async(o,e)=>{let{findNewsByAuthorIdController:t}=It();await t.handle(o,e)});D.put("/:id",(o,e,t)=>{Ze.authenticated(o,e,t)},j.single("image"),async(o,e)=>{let{updateNewsController:t}=Tt();await t.handle(o,e)});D.delete("/:id",(o,e,t)=>{Ze.authenticated(o,e,t)},async(o,e)=>{let{deleteNewsController:t}=Ut();await t.handle(o,e)});import{Router as Pr}from"express";import k from"zod";var Mr=k.object({teamId:k.uuid(),member:k.object({userId:k.uuid(),role:k.string(),description:k.string()})}),Ue=class{constructor(e,t){this.teamMemberRepository=e;this.userRepository=t}async handle(e,t){try{let r=Mr.safeParse({...e.body,teamId:e.params.teamId});if(!r.success)return t.status(400).json({errors:k.prettifyError(r.error)});let{teamId:i,member:{userId:s,...a}}=r.data;if(!await this.userRepository.findById(s))return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let m=await this.teamMemberRepository.create({...a,userId:s,teamId:i});t.status(201).json(m)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Je}from"zod";var Or=Je.object({id:Je.uuid()}),Se=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=Or.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Je.prettifyError(r.error)});let{id:i}=r.data;await this.teamMemberRepository.delete(i),t.status(200).json({message:"Membro removido com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Xe}from"zod";var kr=Xe.object({id:Xe.uuid()}),Ce=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=kr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Xe.prettifyError(r.error)});let{id:i}=r.data,s=await this.teamMemberRepository.findById(i);if(!s)return t.status(404).json({message:"Membro n\xE3o encontrado."});t.status(200).json(s)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as L}from"zod";var qr=L.object({id:L.uuid(),role:L.string(),userId:L.string(),description:L.string()}),be=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=qr.safeParse(e.body);if(!r.success)return t.status(400).json({errors:L.prettifyError(r.error)});let i=r.data,s=await this.teamMemberRepository.update(i);t.status(200).json(s)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var _=class{constructor(e){this.prisma=e}async findById(e){return await this.prisma.teamMember.findFirst({where:{id:e}})}async findByTeamId(e){return await this.prisma.teamMember.findMany({where:{teamId:e}})}async create({description:e,role:t,teamId:r,userId:i}){return await this.prisma.teamMember.create({data:{role:t,description:e,teamId:r,userId:i}})}async update({id:e,...t}){return await this.prisma.teamMember.update({where:{id:e},data:t})}async updateMany({members:e,teamId:t}){await Promise.all(e.map(async({user:r,role:i})=>{let s=await this.prisma.teamMember.findFirst({where:{teamId:t,userId:r.id},include:{user:!0}});s?await this.prisma.teamMember.update({where:{id:s.id},data:{role:i}}):await this.prisma.teamMember.create({data:{teamId:t,userId:r.id,role:i}})}))}async delete(e){await this.prisma.teamMember.deleteMany({where:{id:e}})}async deleteMany(e){await Promise.all(e.map(async t=>{await this.prisma.teamMember.delete({where:{id:t}})}))}};function St(){return{createTeamMemberController:new Ue(new _(f),y())}}function Ct(){return{findTeamMemberController:new Ce(new _(f))}}function bt(){return{updateTeamMemberController:new be(new _(f))}}function At(){return{deleteTeamMemberController:new Se(new _(f))}}var W=Pr(),{authMiddleware:Ae}=h();W.post("/:teamId/member",(o,e,t)=>{Ae.isAdmin(o,e,t)},async(o,e)=>{let{createTeamMemberController:t}=St();await t.handle(o,e)});W.get("/member/:id",(o,e,t)=>{Ae.isAdmin(o,e,t)},async(o,e)=>{let{findTeamMemberController:t}=Ct();await t.handle(o,e)});W.put("/member/:id",(o,e,t)=>{Ae.isAdmin(o,e,t)},async(o,e)=>{let{updateTeamMemberController:t}=bt();await t.handle(o,e)});W.delete("/member/:id",(o,e,t)=>{Ae.isAdmin(o,e,t)},async(o,e)=>{let{deleteTeamMemberController:t}=At();await t.handle(o,e)});import{Router as Wr}from"express";import v from"zod";var Qr=v.object({name:v.string().min(1),type:v.string().min(1),members:v.array(v.object({role:v.string().min(1),user:v.object({id:v.string()})}))}),Be=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=Qr.safeParse(e.body);if(!r.success)return t.status(400).json({errors:v.prettifyError(r.error)});let{name:i,type:s,members:a}=r.data,n=await this.teamRepository.create({name:i,type:s,members:a});t.status(201).json(n)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Ye}from"zod";var Hr=Ye.object({id:Ye.uuid()}),_e=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=Hr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ye.prettifyError(r.error)});let{id:i}=r.data;await this.teamRepository.delete(i),t.status(200).json({message:"Equipe deletada com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as $e}from"zod";var zr=$e.object({id:$e.uuid()}),ve=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=zr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:$e.prettifyError(r.error)});let{id:i}=r.data,s=await this.teamRepository.findById(i);t.status(200).json(s)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Fe}from"zod";var Kr=Fe.object({type:Fe.string(),name:Fe.string().optional()}),xe=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=Kr.safeParse({type:e.params.type,name:e.query.name});if(!r.success)return t.status(400).json({errors:Fe.prettifyError?.(r.error)});let{type:i,name:s}=r.data,a=await this.teamRepository.findByType({type:i,filter:{name:s}});t.status(200).json(a)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var je=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=await this.teamRepository.findAll();return t.status(200).json(r)}catch(r){if(console.error(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import{z as U}from"zod";var Lr=U.object({id:U.uuid(),name:U.string().min(1),members:U.array(U.object({role:U.string(),id:U.uuid(),user:U.object({id:U.uuid()})}))}),De=class{constructor(e,t){this.teamRepository=e;this.teamMemberRepository=t}async handle(e,t){try{let r=Lr.safeParse({id:e.params.id,...e.body});if(!r.success)return t.status(400).json({errors:U.prettifyError(r.error)});let{name:i,members:s,id:a}=r.data,n=await this.teamMemberRepository.findByTeamId(a),m=s.map(d=>d.id),p=n.filter(d=>!m.includes(d.id)).map(d=>d.id);await this.teamMemberRepository.deleteMany(p),await this.teamMemberRepository.updateMany({teamId:a,members:s});let u=await this.teamRepository.update({id:a,name:i});t.status(200).json(u)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var Ne=class{constructor(e){this.prisma=e}async create({members:e,name:t,type:r}){return await this.prisma.team.create({data:{name:t,type:r,members:{create:e.map(({role:i,user:s})=>({role:i,user:{connect:{id:s.id}}}))}}})}async findAll(){return await this.prisma.team.findMany({include:{members:{include:{user:!0}}}})}async findById(e){return await this.prisma.team.findUnique({where:{id:e},include:{members:{include:{user:!0}}}})}async findByType({type:e,filter:{name:t}}){let r={type:e};return t&&(r.name={contains:t,mode:"insensitive"}),await this.prisma.team.findMany({where:r,include:{members:{include:{user:!0}}}})}async update({id:e,name:t}){return await this.prisma.team.update({where:{id:e},data:{name:t}})}async delete(e){await this.prisma.team.delete({where:{id:e}})}};function q(){return new Ne(f)}function Bt(){return new _(f)}function _t(){return{findTeamsController:new je(q())}}function vt(){return{findTeamByIdController:new ve(q())}}function Ft(){return{findTeamByTypeController:new xe(q())}}function xt(){return{createTeamController:new Be(q())}}function jt(){return{updateTeamController:new De(q(),Bt())}}function Dt(){return{deleteTeamController:new _e(q())}}var N=Wr(),{authMiddleware:Ve}=h();N.get("/",async(o,e)=>{let{findTeamsController:t}=_t();await t.handle(o,e)});N.get("/id/:id",async(o,e)=>{let{findTeamByIdController:t}=vt();await t.handle(o,e)});N.get("/type/:type",async(o,e)=>{let{findTeamByTypeController:t}=Ft();await t.handle(o,e)});N.post("/",(o,e,t)=>{Ve.isAdmin(o,e,t)},async(o,e)=>{let{createTeamController:t}=xt();await t.handle(o,e)});N.put("/:id",(o,e,t)=>{Ve.isAdmin(o,e,t)},async(o,e)=>{let{updateTeamController:t}=jt();await t.handle(o,e)});N.delete("/:id",(o,e,t)=>{Ve.isAdmin(o,e,t)},async(o,e)=>{let{deleteTeamController:t}=Dt();await t.handle(o,e)});import{Router as eo}from"express";import Nt from"zod";var Gr=Nt.object({id:Nt.string()}),Me=class{constructor(e){this.userRepository=e}async handle(e,t){try{let{id:r}=Gr.parse(e.body),i=await this.userRepository.findById(r);if(!i)return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let s=e.user.id;return i.id!==s?t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para deletar o usu\xE1rio"}):(await this.userRepository.deleteById(i.id),t.status(200).json({message:"Usu\xE1rio deletado com sucesso!"}))}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as et}from"zod";var Zr=et.object({id:et.string().min(1,"id do usu\xE1rio n\xE3o fornecido.")}),Oe=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=Zr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:et.treeifyError(r.error)});let{id:i}=r.data,s=await this.userRepository.findById(i);if(!s)return t.status(404).json({message:"Usu\xE1rio n\xE3o encontrado"});t.status(200).json(s)}catch(r){console.log(r),r instanceof Error&&t.status(400).json({message:"Erro ao buscar usu\xE1rio"})}}};var ke=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=await this.userRepository.find();t.status(200).json(r)}catch(r){console.log(r),r instanceof Error&&t.status(400).json({message:"Erro ao buscar usu\xE1rios"})}}};import P from"zod";var Ot=2,Mt=1024,Jr=Mt*Mt,Xr=Ot*Jr,Yr=/^\d{4}-\d{4}-\d{4}-\d{4}$/,qe=/^[^0-9]*$/,$r=/^\(?\d{2}\)?[\s-]?\d{4,5}-?\d{4}$/,Vr=P.object({name:P.string().optional(),lattesUrl:P.string().optional(),orcid:P.string().transform(o=>o.trim()).transform(o=>qe.test(o)?"":o).refine(o=>qe.test(o)||Yr.test(o),{message:"ORCID inv\xE1lido. Deve estar no formato 0000-0000-0000-0000"}),phone:P.string().transform(o=>qe.test(o)?"":o).refine(o=>qe.test(o)||$r.test(o),{message:"Telefone inv\xE1lido. Deve estar no formato (99) 99999-9999"}),avatarImage:P.any().refine(o=>o==null?!0:typeof o!="object"||typeof o.size!="number"?!1:o.size<=Xr,`A imagem deve ter no m\xE1ximo ${Ot}MB.`).optional()}),Pe=class{constructor(e,t){this.userRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Vr.safeParse({...e.body,avatarImage:e.file});if(!r.success)return t.status(400).json({errors:P.prettifyError(r.error)});let{avatarImage:i,...s}=r.data,a=e.user.id,n=await this.userRepository.findById(a);if(!n)return t.status(400).json({message:"O usu\xE1rio n\xE3o existe"});let m=n.avatarUrl;return i&&(n.avatarUrl?m=await this.firebaseStorageService.updateFile({file:i,id:a,folder:w.USER,fileUrl:n.avatarUrl}):m=await this.firebaseStorageService.uploadFile({file:i,id:a,folder:w.USER})),await this.userRepository.update({...s,id:a,avatarUrl:m||void 0}),t.status(200).json({message:"Usu\xE1rio atualizado com sucesso."})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};function kt(){return{updateUserController:new Pe(y(),E())}}function qt(){return{deleteUserController:new Me(y())}}function Pt(){return{findUsersController:new ke(y())}}function Qt(){return{findUserController:new Oe(y())}}var G=eo(),{authMiddleware:Ht}=h();G.get("/:id",async(o,e)=>{let{findUserController:t}=Qt();await t.handle(o,e)});G.put("/",(o,e,t)=>{Ht.authenticated(o,e,t)},j.single("avatarImage"),async(o,e)=>{let{updateUserController:t}=kt();await t.handle(o,e)});G.delete("/",(o,e,t)=>{Ht.authenticated(o,e,t)},async(o,e)=>{let{deleteUserController:t}=qt();await t.handle(o,e)});G.get("/",async(o,e)=>{let{findUsersController:t}=Pt();await t.handle(o,e)});var g=tt(),ro={methods:["GET","POST","PUT","DELETE"],origin:["http://localhost:3000","https://rede-ct.vercel.app"],credentials:!0};g.use(to(ro));g.use(tt.json());g.use(tt.urlencoded({extended:!1}));g.use("/",Le);g.use("/auth",x);g.use("/user",G);g.use("/news",D);g.use("/team",N);g.use("/team",W);g.use("/certification",O);var so=oo.createServer(g),zt=4e3;so.listen(zt,()=>{console.log(`\u{1F680} Aplica\xE7\xE3o rodando na porta ${zt}.`)});

import gr from"node:http";import hr from"cors";import Me from"express";import{Router as kt}from"express";import K from"zod";var wt=K.object({password:K.string(),email:K.email()}),z=class{constructor(e,t,r){this.userRepository=e;this.bcrypt=t;this.jwtService=r}async handle(e,t){try{let r=wt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:K.prettifyError(r.error)});let{email:a,password:o}=r.data,i=await this.userRepository.findByEmail(a);if(!i)return t.status(401).json({message:"Usu\xE1rio n\xE3o existe."});if(!await this.bcrypt.compare({password:o,hashedPassword:i.passwordHash}))return t.status(401).json({message:"Senha inv\xE1lida."});let{id:n,role:p}=i,u=this.jwtService.sign({id:n,role:p,email:a});return t.status(200).json({token:u})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import x from"zod";var L=8,gt=x.object({name:x.string("Nome \xE9 obrigat\xF3rio.").min(1,"Nome \xE9 obrigat\xF3rio."),email:x.email("E-mail inv\xE1lido.").min(1,"E-mail \xE9 obrigat\xF3rio."),password:x.string("A senha \xE9 obrigat\xF3ria.").min(L,`A senha deve ter pelo menos ${L} caracteres.`),confirmPassword:x.string("A senha \xE9 obrigat\xF3ria.").min(L,`A senha deve ter pelo menos ${L} caracteres.`)}).refine(s=>s.password===s.confirmPassword,{message:"As senhas n\xE3o coincidem.",path:["confirmPassword"]}),W=class{constructor(e,t){this.userRepository=e;this.bcrypt=t}async handle(e,t){try{let r=gt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:x.prettifyError(r.error)});let{email:a,name:o,password:i}=r.data;if(await this.userRepository.findByEmail(a))return t.status(400).json({message:"Usu\xE1rio j\xE1 existe."});let n=await this.bcrypt.hash(i);return await this.userRepository.create({name:o,emailAddress:a,passwordHash:n}),t.status(201).json({message:"Usu\xE1rio criado com sucesso."})}catch(r){if(r instanceof Error)return t.status(400).json({message:r.message})}}};import{PrismaClient as Et}from"@prisma/client";var y=new Et({log:["query"]});var Z=class{constructor(e){this.prisma=e}async create(e){await this.prisma.user.create({data:e})}async update(e){await this.prisma.user.update({where:{id:e.id},data:e})}async deleteById(e){await this.prisma.user.delete({where:{id:e}})}async find(){return await this.prisma.user.findMany({omit:{passwordHash:!0}})}async findByEmail(e){return await this.prisma.user.findFirst({where:{emailAddress:e}})}async findById(e){return await this.prisma.user.findFirst({where:{id:e}})}};function g(){return new Z(y)}import{compare as It,hash as Tt}from"bcryptjs";var J=class{constructor(e,t){this.hashFn=e;this.compareFn=t}async hash(e){return await this.hashFn(e,6)}async compare({password:e,hashedPassword:t}){return await this.compareFn(e,t)}};function q(){return new J(Tt,It)}import De from"jsonwebtoken";import f from"zod";var bt=f.object({JWT_SECRET:f.string(),FIREBASE_BUCKET:f.string(),FIREBASE_CLIENT_EMAIL:f.string(),FIREBASE_PRIVATE_KEY:f.string(),FIREBASE_PROJECT_ID:f.string(),FIREBASE_TYPE:f.string(),FIREBASE_PRIVATE_KEY_ID:f.string(),FIREBASE_CLIENT_ID:f.string(),FIREBASE_AUTH_URI:f.string(),FIREBASE_TOKEN_URI:f.string(),FIREBASE_AUTH_PROVIDER_X509_CERT_URL:f.string(),FIREBASE_CLIENT_X509_CERT_URL:f.string()}),d=bt.parse(process.env);var Y=class{constructor(e,t){this.signFn=e;this.verifyFn=t}sign(e){try{return this.signFn(e,d.JWT_SECRET,{expiresIn:"3d",subject:e.id})}catch{return null}}verify(e){try{return this.verifyFn(e,d.JWT_SECRET)}catch{return null}}};function G(){return new Y(De.sign,De.verify)}function ke(){return{signUpController:new W(g(),q())}}function Oe(){return{signInController:new z(g(),q(),G())}}var V=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=e.user.id,a=await this.userRepository.findById(r);return a?t.status(200).json(a):t.status(404).json({message:"Usu\xE1rio n\xE3o encontrado."})}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};import U from"zod";var Ut=1,St=7,At=U.object({page:U.coerce.number().min(1).default(Ut),limit:U.coerce.number().min(1).default(St),title:U.string().optional(),content:U.string().optional(),orderBy:U.union([U.enum(["asc","desc"]),U.literal("")]).optional().transform(s=>s===""?void 0:s)}),X=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=At.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:U.prettifyError(r.error)});let{page:a,limit:o,content:i,orderBy:m,title:n}=r.data,p=o*a-o,u=e.user.id,[h,l]=await Promise.all([this.newsRepository.findByAuthorId({authorId:u,pagination:{offset:p,limit:o},filter:{orderBy:m,title:n,content:i}}),this.newsRepository.count({filter:{authorId:u,content:i,title:n}})]),B=Math.ceil(l/o);t.status(200).json({page:a,totalPages:B,offset:p,limit:o,news:h})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Pe from"zod";var Bt=Pe.object({id:Pe.string()}),$=class{constructor(e){this.userRepository=e}async handle(e,t){try{let{id:r}=Bt.parse(e.body),a=await this.userRepository.findById(r);if(!a)return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let o=e.user.id;return a.id!==o?t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para deletar o usu\xE1rio"}):(await this.userRepository.deleteById(a.id),t.status(200).json({message:"Usu\xE1rio deletado com sucesso!"}))}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};var ee=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=await this.userRepository.find();t.status(200).json(r)}catch(r){console.log(r),r instanceof Error&&t.status(400).json({message:"Erro ao buscar usu\xE1rios"})}}};import{UserRole as Qe}from"@prisma/client";import C from"zod";var F={NEWS:"news",USER:"user"};var vt=5,qe=1024,_t=qe*qe,Ct=vt*_t,jt=C.object({id:C.uuid(),name:C.string().optional(),password:C.string().optional(),role:C.enum(Qe).optional(),avatarImage:C.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=Ct,{message:"O avatar deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."}).optional()}),te=class{constructor(e,t,r){this.userRepository=e;this.firebaseStorageService=t;this.bcryptService=r}async handle(e,t){try{let r=jt.safeParse({...e.body,avatarImage:e.file});if(!r.success)return t.status(400).json({errors:C.prettifyError(r.error)});let{id:a,name:o,role:i,password:m,avatarImage:n}=r.data;if(e.user.id!==a)return t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para atualizar o usu\xE1rio."});let u;m&&(u=await this.bcryptService.hash(m));let h;n&&(h=await this.firebaseStorageService.uploadFile({file:n,id:a,folder:F.USER}));let l=e.user.role,B;return l===Qe.ADMIN&&(B=i),await this.userRepository.update({avatarUrl:h,id:a,name:o,passwordHash:u,role:B}),t.status(200).json({message:"Usu\xE1rio atualizado com sucesso."})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};var re=class{constructor(e){this.prisma=e}async create({authorId:e,...t}){return await this.prisma.news.create({data:{...t,author:{connect:{id:e}}}})}async find({pagination:{offset:e,limit:t},filter:{authorId:r,content:a,title:o,orderBy:i="desc"}}){let m={};r&&(m.authorId={contains:r,mode:"insensitive"});let n=[];return o&&n.push({title:{contains:o,mode:"insensitive"}}),a&&n.push({content:{contains:a,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({where:m,omit:{authorId:!0},include:{author:!0},orderBy:{updatedAt:i},skip:e,take:t})}async findById(e){return await this.prisma.news.findUnique({where:{id:e},omit:{authorId:!0},include:{author:!0}})}async findByAuthorId({authorId:e,pagination:{offset:t,limit:r},filter:{orderBy:a="desc",content:o,title:i}}){let m={authorId:e},n=[];return i&&n.push({title:{contains:i,mode:"insensitive"}}),o&&n.push({content:{contains:o,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({omit:{authorId:!0},where:m,orderBy:{updatedAt:a},skip:t,take:r})}async update(e){return await this.prisma.news.update({where:{id:e.id},data:{title:e.title,content:e.content,imageUrl:e.imageUrl}})}async delete(e){await this.prisma.news.delete({where:{id:e}})}async count({filter:{authorId:e,content:t,title:r}}){let a={};e&&(a.authorId={contains:e,mode:"insensitive"});let o=[];return r&&o.push({title:{contains:r,mode:"insensitive"}}),t&&o.push({content:{contains:t,mode:"insensitive"}}),o.length>0&&(a.OR=o),await this.prisma.news.count({where:a})}};function S(){return new re(y)}import{getStorage as xt}from"firebase-admin/storage";import{config as Nt}from"dotenv";import He from"firebase-admin";Nt();var Ue=He.initializeApp({credential:He.credential.cert({clientEmail:d.FIREBASE_CLIENT_EMAIL,privateKey:d.FIREBASE_PRIVATE_KEY,projectId:d.FIREBASE_PROJECT_ID,type:d.FIREBASE_TYPE,privateKeyId:d.FIREBASE_PRIVATE_KEY_ID,clientId:d.FIREBASE_CLIENT_ID,authUri:d.FIREBASE_AUTH_URI,tokenUri:d.FIREBASE_TOKEN_URI,authProviderX509CertUrl:d.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,clientX509CertUrl:d.FIREBASE_CLIENT_X509_CERT_URL}),storageBucket:d.FIREBASE_BUCKET});Ue.name?console.log("\u{1F525} Firebase conectado com sucesso!"):console.error("\u274C Erro ao se conectar ao Firebase.");var Ft=xt(Ue),Ke=Ft.bucket(d.FIREBASE_BUCKET);import{randomUUID as Mt}from"node:crypto";var Dt=/\/images\/.+$/,se=class{constructor(e){this.bucket=e}async uploadFile({file:e,folder:t,id:r}){let a=`${Mt()}-${e?.originalname}`,o=this.bucket.file(`images/${t}/${r}/${a}`);return await new Promise((i,m)=>{let n=o.createWriteStream({metadata:{contentType:e?.mimetype}});n.on("error",p=>{console.log(p),m(p)}),n.on("finish",async()=>{try{await o.makePublic();let p=`https://storage.googleapis.com/${this.bucket.name}/${o.name}`;i(p)}catch(p){console.error(p),m(p)}}),n.end(e.buffer)})}async updateFile({file:e,id:t,imageUrl:r,folder:a}){try{let o=this.getPath(r);if(!o)throw new Error("Arquivo n\xE3o encontrado.");let[i,m]=await Promise.all([this.bucket.file(o).delete(),this.uploadFile({file:e,id:t,folder:a})]);return m}catch(o){throw console.error(o),new Error("Erro ao atualizar o arquivo.")}}async deleteFile({imageUrl:e}){let t=this.getPath(e);if(!t)throw new Error("Arquivo n\xE3o encontrado.");try{await this.bucket.file(t).delete()}catch(r){throw console.error(r),new Error("Erro ao deletar o arquivo.")}}getPath(e){let t=e.match(Dt);return t?t[0].slice(1):null}};function M(){return new se(Ke)}function ze(){return{updateUserController:new te(g(),M(),q())}}function Le(){return{deleteUserController:new $(g())}}function We(){return{findUsersController:new ee(g())}}function Ze(){return{findAuthenticatedUserController:new V(g())}}function Je(){return{findAuthenticatedUserController:new X(S())}}var oe=class{constructor(e){this.jwtService=e}authenticated(e,t,r){let a=e.headers.authorization;if(!a)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(a);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});e.user=o,r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}isAdmin(e,t,r){let a=e.headers.authorization;if(!a)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(a);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});if(o.role!=="ADMIN")return t.status(401).json({message:"\xC9 necess\xE1rio ter permiss\xF5es de administrador."});r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}};function E(){return{authMiddleware:new oe(G())}}var D=kt(),{signUpController:Ot}=ke(),{signInController:Pt}=Oe(),{authMiddleware:Ye}=E();D.post("/sign-up",async(s,e)=>{await Ot.handle(s,e)});D.post("/sign-in",async(s,e)=>{await Pt.handle(s,e)});D.get("/user",(s,e,t)=>{Ye.authenticated(s,e,t)},async(s,e)=>{let{findAuthenticatedUserController:t}=Ze();await t.handle(s,e)});D.get("/user/news",(s,e,t)=>{Ye.authenticated(s,e,t)},async(s,e)=>{let{findAuthenticatedUserController:t}=Je();await t.handle(s,e)});import{Router as qt}from"express";var Se=qt();Se.get("/",(s,e)=>{e.status(200).json({message:"Rede CT"})});import{Router as sr}from"express";import Q from"zod";var Qt=5,Ge=1024,Ht=Ge*Ge,Kt=Qt*Ht,zt=Q.object({title:Q.string().min(1),content:Q.string().min(1),image:Q.any().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=Kt,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),ae=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=zt.safeParse({...e.body,image:e.file});if(!r.success)return t.status(400).json({errors:Q.prettifyError(r.error)});let{title:a,content:o,image:i}=r.data,m=e.user.id,n=await this.firebaseStorageService.uploadFile({file:i,folder:F.NEWS,id:m}),p=await this.newsRepository.create({title:a,content:o,authorId:m,imageUrl:n});t.status(201).json(p)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Ae from"zod";var Lt=Ae.object({id:Ae.string()}),ie=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Lt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ae.prettifyError(r.error)});let{id:a}=r.data,o=e.user.id,i=await this.newsRepository.findById(a);if(!i)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});if(i.author.id!==o)return t.status(401).json({message:"Sem permiss\xE3o."});await Promise.all([this.newsRepository.delete(a),this.firebaseStorageService.deleteFile({imageUrl:i.imageUrl})]),t.status(200).json({message:"Not\xEDcia deletada com sucesso."})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import I from"zod";var Wt=1,Zt=7,Jt=I.object({page:I.coerce.number().min(1).default(Wt),limit:I.coerce.number().min(1).default(Zt),authorId:I.string(),title:I.string().optional(),content:I.string().optional(),orderBy:I.union([I.enum(["asc","desc"]),I.literal("")]).optional().transform(s=>s===""?void 0:s)}),ne=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Jt.safeParse({page:e.query.page,limit:e.query.limit,author_id:e.params.author_id,title:e.query.title,content:e.query.content,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:I.prettifyError(r.error)});let{page:a,limit:o,authorId:i,content:m,orderBy:n,title:p}=r.data,u=o*a-o,[h,l]=await Promise.all([this.newsRepository.findByAuthorId({authorId:i,pagination:{offset:u,limit:o},filter:{orderBy:n,title:p,content:m}}),this.newsRepository.count({filter:{authorId:i,content:m,title:p}})]),B=Math.ceil(l/o);t.status(200).json({page:a,totalPages:B,offset:u,limit:o,news:h})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Be from"zod";var Yt=Be.object({id:Be.string()}),me=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Yt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Be.prettifyError(r.error)});let{id:a}=r.data,o=await this.newsRepository.findById(a);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import T from"zod";var Gt=1,Vt=9,Xt=T.object({page:T.coerce.number().min(1).default(Gt),limit:T.coerce.number().min(1).default(Vt),title:T.string().optional(),content:T.string().optional(),authorId:T.string().optional(),orderBy:T.union([T.enum(["asc","desc"]),T.literal("")]).optional().transform(s=>s===""?void 0:s)}),pe=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Xt.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,author_id:e.query.author_id,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:T.prettifyError(r.error)});let{page:a,limit:o,authorId:i,content:m,orderBy:n="desc",title:p}=r.data,u=o*a-o,[h,l]=await Promise.all([this.newsRepository.find({pagination:{offset:u,limit:o},filter:{authorId:i,content:m,title:p,orderBy:n}}),this.newsRepository.count({filter:{title:p,content:m,authorId:i}})]),B=Math.min(Math.ceil(l/o),1);t.status(200).json({page:a,totalPages:B,offset:u,limit:o,news:h})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import k from"zod";var $t=5,Ve=1024,er=Ve*Ve,tr=$t*er,rr=k.object({id:k.string(),title:k.string().min(1),content:k.string().min(1),image:k.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=tr,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),ce=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=rr.safeParse({id:e.params.id,title:e.body.title,content:e.body.content,image:e.file});if(!r.success)return t.status(400).json({errors:k.prettifyError(r.error)});let{id:a,title:o,content:i,image:m}=r.data,n=await this.newsRepository.findById(a);if(!n)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});let p=e.user.id;if(n.author.id!==p)return t.status(401).json({message:"Sem permiss\xE3o."});let u;m&&n.imageUrl&&(u=await this.firebaseStorageService.updateFile({file:m,folder:F.NEWS,id:a,imageUrl:n.imageUrl}));let h=await this.newsRepository.update({id:a,title:o,content:i,imageUrl:u});t.status(200).json(h)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};function Xe(){return{createNewsController:new ae(S(),M())}}function $e(){return{findAllNewsController:new pe(S())}}function et(){return{findNewsByIdController:new me(S())}}function tt(){return{findNewsByAuthorIdController:new ne(S())}}function rt(){return{updateNewsController:new ce(S(),M())}}function st(){return{deleteNewsController:new ie(S(),M())}}import ot from"multer";var ve=ot({storage:ot.memoryStorage()});var v=sr(),{authMiddleware:_e}=E();v.post("/",(s,e,t)=>{_e.authenticated(s,e,t)},ve.single("image"),async(s,e)=>{let{createNewsController:t}=Xe();await t.handle(s,e)});v.get("/",async(s,e)=>{let{findAllNewsController:t}=$e();await t.handle(s,e)});v.get("/:id",async(s,e)=>{let{findNewsByIdController:t}=et();await t.handle(s,e)});v.get("/author/:authorId",async(s,e)=>{let{findNewsByAuthorIdController:t}=tt();await t.handle(s,e)});v.put("/:id",(s,e,t)=>{_e.authenticated(s,e,t)},ve.single("image"),async(s,e)=>{let{updateNewsController:t}=rt();await t.handle(s,e)});v.delete("/:id",(s,e,t)=>{_e.authenticated(s,e,t)},async(s,e)=>{let{deleteNewsController:t}=st();await t.handle(s,e)});import{Router as mr}from"express";import j from"zod";var or=j.object({teamId:j.uuid(),member:j.object({userId:j.uuid(),role:j.string(),description:j.string()})}),ue=class{constructor(e,t){this.teamMemberRepository=e;this.userRepository=t}async handle(e,t){try{let r=or.safeParse({...e.body,teamId:e.params.teamId});if(!r.success)return t.status(400).json({errors:j.prettifyError(r.error)});let{teamId:a,member:{userId:o,...i}}=r.data;if(!await this.userRepository.findById(o))return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let n=await this.teamMemberRepository.create({...i,userId:o,teamId:a});t.status(201).json(n)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Ce}from"zod";var ar=Ce.object({id:Ce.uuid()}),de=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=ar.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ce.prettifyError(r.error)});let{id:a}=r.data;await this.teamMemberRepository.delete(a),t.status(200).json({message:"Membro removido com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as je}from"zod";var ir=je.object({id:je.uuid()}),le=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=ir.safeParse(e.params);if(!r.success)return t.status(400).json({errors:je.prettifyError(r.error)});let{id:a}=r.data,o=await this.teamMemberRepository.findById(a);if(!o)return t.status(404).json({message:"Membro n\xE3o encontrado."});t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as O}from"zod";var nr=O.object({id:O.uuid(),role:O.string(),userId:O.string(),description:O.string()}),ye=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=nr.safeParse(e.body);if(!r.success)return t.status(400).json({errors:O.prettifyError(r.error)});let a=r.data,o=await this.teamMemberRepository.update(a);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var A=class{constructor(e){this.prisma=e}async findById(e){return await this.prisma.teamMember.findFirst({where:{id:e}})}async findByTeamId(e){return await this.prisma.teamMember.findMany({where:{teamId:e}})}async create({description:e,role:t,teamId:r,userId:a}){return await this.prisma.teamMember.create({data:{role:t,description:e,teamId:r,userId:a}})}async update({id:e,...t}){return await this.prisma.teamMember.update({where:{id:e},data:t})}async updateMany({members:e,teamId:t}){await Promise.all(e.map(async r=>{let a=await this.prisma.teamMember.findFirst({where:{teamId:t,userId:r.user.id},include:{user:!0}});a?await this.prisma.teamMember.update({where:{id:a.id},data:{role:r.role}}):await this.prisma.teamMember.create({data:{teamId:t,userId:r.user.id,role:r.role}})}))}async delete(e){await this.prisma.teamMember.deleteMany({where:{id:e}})}async deleteMany(e){await Promise.all(e.map(async t=>{await this.prisma.teamMember.delete({where:{id:t}})}))}};function at(){return{createTeamMemberController:new ue(new A(y),g())}}function it(){return{findTeamMemberController:new le(new A(y))}}function nt(){return{updateTeamMemberController:new ye(new A(y))}}function mt(){return{deleteTeamMemberController:new de(new A(y))}}var P=mr(),{authMiddleware:fe}=E();P.post("/:teamId/member",(s,e,t)=>{fe.isAdmin(s,e,t)},async(s,e)=>{let{createTeamMemberController:t}=at();await t.handle(s,e)});P.get("/member/:id",(s,e,t)=>{fe.isAdmin(s,e,t)},async(s,e)=>{let{findTeamMemberController:t}=it();await t.handle(s,e)});P.put("/member/:id",(s,e,t)=>{fe.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamMemberController:t}=nt();await t.handle(s,e)});P.delete("/member/:id",(s,e,t)=>{fe.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamMemberController:t}=mt();await t.handle(s,e)});import{Router as fr}from"express";import b from"zod";var pr=b.object({name:b.string().min(1),type:b.string().min(1),members:b.array(b.object({role:b.string().min(1),description:b.string().min(1),user:b.object({id:b.string()})}))}),Re=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=pr.safeParse(e.body);if(!r.success)return t.status(400).json({errors:b.prettifyError(r.error)});let{name:a,type:o,members:i}=r.data,m=await this.teamRepository.create({name:a,type:o,members:i});t.status(201).json(m)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Ne}from"zod";var cr=Ne.object({id:Ne.uuid()}),he=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=cr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ne.prettifyError(r.error)});let{id:a}=r.data;await this.teamRepository.delete(a),t.status(200).json({message:"Equipe deletada com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as xe}from"zod";var ur=xe.object({id:xe.uuid()}),we=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=ur.safeParse(e.params);if(!r.success)return t.status(400).json({errors:xe.prettifyError(r.error)});let{id:a}=r.data,o=await this.teamRepository.findById(a);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as ge}from"zod";var dr=ge.object({type:ge.string(),name:ge.string().optional()}),Ee=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=dr.safeParse({type:e.params.type,name:e.query.name});if(!r.success)return t.status(400).json({errors:ge.prettifyError?.(r.error)});let{type:a,name:o}=r.data,i=await this.teamRepository.findByType({type:a,filter:{name:o}});t.status(200).json(i)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var Ie=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=await this.teamRepository.findAll();return t.status(200).json(r)}catch(r){if(console.error(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import{z as R}from"zod";var lr=R.object({id:R.uuid()}),yr=R.object({name:R.string().min(1),members:R.array(R.object({id:R.uuid(),role:R.string(),user:R.object({id:R.uuid(),name:R.string()})}))}),Te=class{constructor(e,t){this.teamRepository=e;this.teamMemberRepository=t}async handle(e,t){try{let r=lr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:R.prettifyError?.(r.error)});let a=yr.safeParse(e.body);if(!a.success)return t.status(400).json({errors:R.prettifyError(a.error)});let{id:o}=r.data,{name:i,members:m}=a.data,n=await this.teamMemberRepository.findByTeamId(o),p=m.map(l=>l.id),u=n.filter(l=>!p.includes(l.id)).map(l=>l.id);await this.teamMemberRepository.deleteMany(u),await this.teamMemberRepository.updateMany({teamId:o,members:m});let h=await this.teamRepository.update({id:o,name:i});t.status(200).json(h)}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};var be=class{constructor(e){this.prisma=e}async create({members:e,name:t,type:r}){return await this.prisma.team.create({data:{name:t,type:r,members:{create:e.map(({description:a,role:o,user:i})=>({role:o,description:a,user:{connect:{id:i.id}}}))}}})}async findAll(){return await this.prisma.team.findMany({include:{members:{include:{user:!0}}}})}async findById(e){return await this.prisma.team.findUnique({where:{id:e},include:{members:{include:{user:!0}}}})}async findByType({type:e,filter:{name:t}}){let r={type:e};return t&&(r.name={contains:t,mode:"insensitive"}),await this.prisma.team.findMany({where:r,include:{members:{include:{user:!0}}}})}async update({id:e,name:t}){return await this.prisma.team.update({where:{id:e},data:{name:t}})}async delete(e){await this.prisma.team.delete({where:{id:e}})}};function N(){return new be(y)}function pt(){return new A(y)}function ct(){return{findTeamsController:new Ie(N())}}function ut(){return{findTeamByIdController:new we(N())}}function dt(){return{findTeamByTypeController:new Ee(N())}}function lt(){return{createTeamController:new Re(N())}}function yt(){return{updateTeamController:new Te(N(),pt())}}function ft(){return{deleteTeamController:new he(N())}}var _=fr(),{authMiddleware:Fe}=E();_.get("/",async(s,e)=>{let{findTeamsController:t}=ct();await t.handle(s,e)});_.get("/id/:id",async(s,e)=>{let{findTeamByIdController:t}=ut();await t.handle(s,e)});_.get("/type/:type",async(s,e)=>{let{findTeamByTypeController:t}=dt();await t.handle(s,e)});_.post("/",(s,e,t)=>{Fe.isAdmin(s,e,t)},async(s,e)=>{let{createTeamController:t}=lt();await t.handle(s,e)});_.put("/:id",(s,e,t)=>{Fe.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamController:t}=yt();await t.handle(s,e)});_.delete("/:id",(s,e,t)=>{Fe.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamController:t}=ft();await t.handle(s,e)});import{Router as Rr}from"express";var H=Rr(),{authMiddleware:Rt}=E();H.get("/",async(s,e)=>{let{findUsersController:t}=We();await t.handle(s,e)});H.put("/",(s,e,t)=>{Rt.authenticated(s,e,t)},async(s,e)=>{let{updateUserController:t}=ze();await t.handle(s,e)});H.delete("/",(s,e,t)=>{Rt.authenticated(s,e,t)},async(s,e)=>{let{deleteUserController:t}=Le();await t.handle(s,e)});var w=Me(),wr={methods:["GET","POST","PUT","DELETE"],origin:["http://localhost:3000","https://rede-ct.vercel.app"],credentials:!0};w.use(hr(wr));w.use(Me.json());w.use(Me.urlencoded({extended:!1}));w.use("/",Se);w.use("/auth",D);w.use("/user",H);w.use("/news",v);w.use("/team",_);w.use("/team",P);var Er=gr.createServer(w),ht=4e3;Er.listen(ht,()=>{console.log(`\u{1F680} Aplica\xE7\xE3o rodando na porta ${ht}.`)});

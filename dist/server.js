import G from"node:http";import w from"express";import F from"cors";import{Router as A}from"express";var v=A();v.get("/",(o,e)=>{e.status(200).json({message:"Rede CT"})});import{Router as T}from"express";import{ClerkExpressWithAuth as q}from"@clerk/clerk-sdk-node";var W=q(),U=(o,e,r)=>W(o,e,r);var c=class{async handle(e,r){let t=e.auth;if(!t||!t.userId){r.status(401).json({message:"N\xE3o autenticado"});return}r.status(200).json({message:"Usu\xE1rio autenticado com Clerk",userId:t.userId})}};function C(){return{clerkAuthController:new c}}var{clerkAuthController:D}=C(),R=T();R.get("/",U,async(o,e)=>{await D.handle(o,e)});import{Router as J}from"express";var d=class{constructor(e,r){this.clerkWebhookService=e;this.userRepository=r}async handle(e,r){try{let t=await this.clerkWebhookService.verifyEvent(e);if(!t)throw new Error("Erro ao verificar webhook.");let{type:s,data:{created_at:a,birthday:p,last_sign_in_at:m,updated_at:x,email_addresses:S,...j}}=t;if(s==="user.created")return await this.userRepository.create({created_at:new Date(a),last_sign_in_at:new Date(m),updated_at:new Date(x),email_addresses:S,...j}),r.status(201).json({message:"Usu\xE1rio criado com sucesso."})}catch(t){if(t instanceof Error)return r.status(400).json({message:t.message})}}};var l=class{constructor(e,r){this.clerkWebhookService=e;this.userRepository=r}async handle(e,r){try{let t=await this.clerkWebhookService.verifyEvent(e);if(!t)throw new Error("Erro ao verificar webhook.");let{type:s,data:a}=t;s==="user.deleted"&&(await this.userRepository.delete(a),r.status(200).json({message:"Usu\xE1rio deletado com sucesso."}))}catch(t){t instanceof Error&&r.status(400).json({message:t.message})}}};var u=class{constructor(e,r){this.clerkWebhookService=e;this.userRepository=r}async handle(e,r){try{let t=await this.clerkWebhookService.verifyEvent(e);if(!t)throw new Error("Erro ao verificar webhook.");let{type:s,data:{email_addresses:a,...p}}=t;s==="user.updated"&&(await this.userRepository.update({...p,email_addresses:a}),r.status(200).json({message:"Usu\xE1rio atualizado com sucesso."}))}catch(t){t instanceof Error&&r.status(400).json({message:t.message})}}};var y=class{constructor(e){this.prisma=e}async create({email_addresses:e,first_name:r,last_name:t,...s}){await this.prisma.user.create({data:{firstName:r,lastName:t??"",id:s.id,createdAt:s.created_at,lastSignInAt:s.last_sign_in_at,updatedAt:s.updated_at,imageUrl:s.image_url,profileImageUrl:s.profile_image_url,privateMetadata:s.private_metadata,publicMetadata:s.public_metadata,unsafeMetadata:s.unsafe_metadata,username:s.username,emailAddresses:{create:e.map(a=>({emailAddress:a.email_address,object:a.object,verification:JSON.stringify(a.verification),linkedTo:JSON.stringify(a.linked_to),id:a.id}))}}})}async update(e){await this.prisma.user.update({where:{id:e.id},data:{firstName:e.first_name,emailAddresses:{update:e.email_addresses.map(r=>({where:{id:r.id},data:{emailAddress:r.email_address,object:r.object,verification:JSON.stringify(r.verification),linkedTo:JSON.stringify(r.linked_to)}}))}}})}async delete(e){await this.prisma.user.delete({where:{id:e.id}})}};import{PrismaClient as N}from"@prisma/client";var E=new N;function f(){return new y(E)}import{Webhook as O}from"svix";var h=class{constructor(e){this.webhook=e}async verifyEvent(e){let{"svix-id":r,"svix-timestamp":t,"svix-signature":s}=e.headers;if(!r||!t||!s)throw new Error("Headers are missing");let a=JSON.stringify(e.body),p={"svix-id":r,"svix-timestamp":t,"svix-signature":s};try{return this.webhook.verify(a,p)}catch(m){if(m instanceof Error)throw new Error(m.message)}}};function k(o){return new h(new O(o))}import{config as P}from"dotenv";P();function g(){return{createUserController:new d(k(process.env.CLERK_USER_CREATED),f())}}function b(){return{updateUserController:new u(k(process.env.CLERK_USER_UPDATED),f())}}function _(){return{deleteUserController:new l(k(process.env.CLERK_USER_DELETED),f())}}var{createUserController:L}=g(),{updateUserController:M}=b(),{deleteUserController:K}=_(),n=J();n.post("/api/webhook/created-user",async(o,e)=>{await L.handle(o,e)});n.post("/api/webhook/updated-user",async(o,e)=>{await M.handle(o,e)});n.post("/api/webhook/deleted-user",async(o,e)=>{await K.handle(o,e)});var i=w(),z={methods:["GET","POST","PUT","DELETE"],origin:["http://localhost:3000","https://rede-ct.vercel.app"],credentials:!0};i.use(F(z));i.use(w.json());i.use(w.urlencoded({extended:!1}));i.use("/",v);i.use("/auth",R);i.use("/user",n);var H=G.createServer(i),I=3e3;H.listen(I,()=>{console.log(`\u{1F680} Aplica\xE7\xE3o rodando na porta ${I}.`)});
//# sourceMappingURL=server.js.map
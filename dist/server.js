import br from"node:http";import Tr from"cors";import qe from"express";import{Router as jt}from"express";var K=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=e.user.id,i=await this.userRepository.findById(r);return i?t.status(200).json(i):t.status(404).json({message:"Usu\xE1rio n\xE3o encontrado."})}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};import T from"zod";var Tt=1,Ut=7,bt=T.object({page:T.coerce.number().min(1).default(Tt),limit:T.coerce.number().min(1).default(Ut),title:T.string().optional(),content:T.string().optional(),orderBy:T.union([T.enum(["asc","desc"]),T.literal("")]).optional().transform(s=>s===""?void 0:s)}),z=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=bt.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:T.prettifyError(r.error)});let{page:i,limit:o,content:a,orderBy:m,title:n}=r.data,p=o*i-o,u=e.user.id,[d,q]=await Promise.all([this.newsRepository.findByAuthorId({authorId:u,pagination:{offset:p,limit:o},filter:{orderBy:m,title:n,content:a}}),this.newsRepository.count({filter:{authorId:u,content:a,title:n}})]),P=Math.ceil(q/o);t.status(200).json({page:i,totalPages:P,offset:p,limit:o,news:d})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import L from"zod";var St=L.object({password:L.string(),email:L.email()}),W=class{constructor(e,t,r){this.userRepository=e;this.bcrypt=t;this.jwtService=r}async handle(e,t){try{let r=St.safeParse(e.body);if(!r.success)return t.status(400).json({errors:L.prettifyError(r.error)});let{email:i,password:o}=r.data,a=await this.userRepository.findByEmail(i);if(!a)return t.status(401).json({message:"Usu\xE1rio n\xE3o existe."});if(!await this.bcrypt.compare({password:o,hashedPassword:a.passwordHash}))return t.status(401).json({message:"Senha inv\xE1lida."});let{id:n,role:p}=a,u=this.jwtService.sign({id:n,role:p,email:i});return t.status(200).json({token:u})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import x from"zod";var Z=8,At=x.object({name:x.string("Nome \xE9 obrigat\xF3rio.").min(1,"Nome \xE9 obrigat\xF3rio."),email:x.email("E-mail inv\xE1lido.").min(1,"E-mail \xE9 obrigat\xF3rio."),password:x.string("A senha \xE9 obrigat\xF3ria.").min(Z,`A senha deve ter pelo menos ${Z} caracteres.`),confirmPassword:x.string("A senha \xE9 obrigat\xF3ria.").min(Z,`A senha deve ter pelo menos ${Z} caracteres.`)}).refine(s=>s.password===s.confirmPassword,{message:"As senhas n\xE3o coincidem.",path:["confirmPassword"]}),J=class{constructor(e,t){this.userRepository=e;this.bcrypt=t}async handle(e,t){try{let r=At.safeParse(e.body);if(!r.success)return t.status(400).json({errors:x.prettifyError(r.error)});let{email:i,name:o,password:a}=r.data;if(await this.userRepository.findByEmail(i))return t.status(400).json({message:"Usu\xE1rio j\xE1 existe."});let n=await this.bcrypt.hash(a);return await this.userRepository.create({name:o,emailAddress:i,passwordHash:n}),t.status(201).json({message:"Usu\xE1rio criado com sucesso."})}catch(r){if(r instanceof Error)return t.status(400).json({message:r.message})}}};import{PrismaClient as Bt}from"@prisma/client";var y=new Bt({log:["query"]});var G=class{constructor(e){this.prisma=e}async create({authorId:e,...t}){return await this.prisma.news.create({data:{...t,author:{connect:{id:e}}}})}async find({pagination:{offset:e,limit:t},filter:{authorId:r,content:i,title:o,orderBy:a="desc"}}){let m={};r&&(m.authorId={contains:r,mode:"insensitive"});let n=[];return o&&n.push({title:{contains:o,mode:"insensitive"}}),i&&n.push({content:{contains:i,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({where:m,omit:{authorId:!0},include:{author:!0},orderBy:{updatedAt:a},skip:e,take:t})}async findById(e){return await this.prisma.news.findUnique({where:{id:e},omit:{authorId:!0},include:{author:!0}})}async findByAuthorId({authorId:e,pagination:{offset:t,limit:r},filter:{orderBy:i="desc",content:o,title:a}}){let m={authorId:e},n=[];return a&&n.push({title:{contains:a,mode:"insensitive"}}),o&&n.push({content:{contains:o,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({omit:{authorId:!0},where:m,orderBy:{updatedAt:i},skip:t,take:r})}async update(e){return await this.prisma.news.update({where:{id:e.id},data:{title:e.title,content:e.content,imageUrl:e.imageUrl}})}async delete(e){await this.prisma.news.delete({where:{id:e}})}async count({filter:{authorId:e,content:t,title:r}}){let i={};e&&(i.authorId={contains:e,mode:"insensitive"});let o=[];return r&&o.push({title:{contains:r,mode:"insensitive"}}),t&&o.push({content:{contains:t,mode:"insensitive"}}),o.length>0&&(i.OR=o),await this.prisma.news.count({where:i})}};function U(){return new G(y)}var X=class{constructor(e){this.prisma=e}async create(e){await this.prisma.user.create({data:e})}async update(e){await this.prisma.user.update({where:{id:e.id},data:e})}async deleteById(e){await this.prisma.user.delete({where:{id:e}})}async find(){return await this.prisma.user.findMany({omit:{passwordHash:!0}})}async findByEmail(e){return await this.prisma.user.findFirst({where:{emailAddress:e}})}async findById(e){return await this.prisma.user.findFirst({where:{id:e}})}};function R(){return new X(y)}import{compare as _t,hash as Ct}from"bcryptjs";var Y=class{constructor(e,t){this.hashFn=e;this.compareFn=t}async hash(e){return await this.hashFn(e,6)}async compare({password:e,hashedPassword:t}){return await this.compareFn(e,t)}};function Ae(){return new Y(Ct,_t)}import Pe from"jsonwebtoken";import f from"zod";var vt=f.object({JWT_SECRET:f.string(),FIREBASE_BUCKET:f.string(),FIREBASE_CLIENT_EMAIL:f.string(),FIREBASE_PRIVATE_KEY:f.string(),FIREBASE_PROJECT_ID:f.string(),FIREBASE_TYPE:f.string(),FIREBASE_PRIVATE_KEY_ID:f.string(),FIREBASE_CLIENT_ID:f.string(),FIREBASE_AUTH_URI:f.string(),FIREBASE_TOKEN_URI:f.string(),FIREBASE_AUTH_PROVIDER_X509_CERT_URL:f.string(),FIREBASE_CLIENT_X509_CERT_URL:f.string()}),l=vt.parse(process.env);var $=class{constructor(e,t){this.signFn=e;this.verifyFn=t}sign(e){try{return this.signFn(e,l.JWT_SECRET,{expiresIn:"3d",subject:e.id})}catch{return null}}verify(e){try{return this.verifyFn(e,l.JWT_SECRET)}catch{return null}}};function V(){return new $(Pe.sign,Pe.verify)}function Qe(){return{signUpController:new J(R(),Ae())}}function He(){return{signInController:new W(R(),Ae(),V())}}function Ke(){return{findAuthenticatedUserController:new K(R())}}function ze(){return{findAuthenticatedUserController:new z(U())}}var ee=class{constructor(e){this.jwtService=e}authenticated(e,t,r){let i=e.headers.authorization;if(!i)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(i);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});e.user=o,r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}isAdmin(e,t,r){let i=e.headers.authorization;if(!i)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(i);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});if(o.role!=="ADMIN")return t.status(401).json({message:"\xC9 necess\xE1rio ter permiss\xF5es de administrador."});r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}};function w(){return{authMiddleware:new ee(V())}}var _=jt(),{signUpController:Nt}=Qe(),{signInController:xt}=He(),{authMiddleware:Be}=w();_.post("/sign-up",async(s,e)=>{await Nt.handle(s,e)});_.post("/sign-in",async(s,e)=>{await xt.handle(s,e)});_.get("/user",(s,e,t)=>{Be.authenticated(s,e,t)},async(s,e)=>{let{findAuthenticatedUserController:t}=Ke();await t.handle(s,e)});_.get("/user/news",(s,e,t)=>{Be.authenticated(s,e,t)},async(s,e)=>{let{findAuthenticatedUserController:t}=ze();await t.handle(s,e)});_.get("/admin",(s,e,t)=>{Be.isAdmin(s,e,t)},(s,e)=>{e.status(200).json({success:!0})});import{Router as Ft}from"express";var _e=Ft();_e.get("/",(s,e)=>{e.status(200).json({message:"Rede CT"})});import{Router as rr}from"express";import Q from"zod";var C={NEWS:"news",USER:"user"};var Dt=5,Le=1024,Mt=Le*Le,kt=Dt*Mt,Ot=Q.object({title:Q.string().min(1),content:Q.string().min(1),image:Q.any().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=kt,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),te=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Ot.safeParse({...e.body,image:e.file});if(!r.success)return t.status(400).json({errors:Q.prettifyError(r.error)});let{title:i,content:o,image:a}=r.data,m=e.user.id,n=await this.firebaseStorageService.uploadFile({file:a,folder:C.NEWS,id:m}),p=await this.newsRepository.create({title:i,content:o,authorId:m,imageUrl:n});t.status(201).json(p)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Ce from"zod";var qt=Ce.object({id:Ce.string()}),re=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=qt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ce.prettifyError(r.error)});let{id:i}=r.data,o=e.user.id,a=await this.newsRepository.findById(i);if(!a)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});if(a.author.id!==o)return t.status(401).json({message:"Sem permiss\xE3o."});await Promise.all([this.newsRepository.delete(i),this.firebaseStorageService.deleteFile({imageUrl:a.imageUrl})]),t.status(200).json({message:"Not\xEDcia deletada com sucesso."})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import g from"zod";var Pt=1,Qt=7,Ht=g.object({page:g.coerce.number().min(1).default(Pt),limit:g.coerce.number().min(1).default(Qt),authorId:g.string(),title:g.string().optional(),content:g.string().optional(),orderBy:g.union([g.enum(["asc","desc"]),g.literal("")]).optional().transform(s=>s===""?void 0:s)}),se=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Ht.safeParse({page:e.query.page,limit:e.query.limit,author_id:e.params.author_id,title:e.query.title,content:e.query.content,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:g.prettifyError(r.error)});let{page:i,limit:o,authorId:a,content:m,orderBy:n,title:p}=r.data,u=o*i-o,[d,q]=await Promise.all([this.newsRepository.findByAuthorId({authorId:a,pagination:{offset:u,limit:o},filter:{orderBy:n,title:p,content:m}}),this.newsRepository.count({filter:{authorId:a,content:m,title:p}})]),P=Math.ceil(q/o);t.status(200).json({page:i,totalPages:P,offset:u,limit:o,news:d})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import ve from"zod";var Kt=ve.object({id:ve.string()}),oe=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Kt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:ve.prettifyError(r.error)});let{id:i}=r.data,o=await this.newsRepository.findById(i);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import E from"zod";var zt=1,Lt=9,Wt=E.object({page:E.coerce.number().min(1).default(zt),limit:E.coerce.number().min(1).default(Lt),title:E.string().optional(),content:E.string().optional(),authorId:E.string().optional(),orderBy:E.union([E.enum(["asc","desc"]),E.literal("")]).optional().transform(s=>s===""?void 0:s)}),ie=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Wt.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,author_id:e.query.author_id,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:E.prettifyError(r.error)});let{page:i,limit:o,authorId:a,content:m,orderBy:n="desc",title:p}=r.data,u=o*i-o,[d,q]=await Promise.all([this.newsRepository.find({pagination:{offset:u,limit:o},filter:{authorId:a,content:m,title:p,orderBy:n}}),this.newsRepository.count({filter:{title:p,content:m,authorId:a}})]),P=Math.min(Math.ceil(q/o),1);t.status(200).json({page:i,totalPages:P,offset:u,limit:o,news:d})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import F from"zod";var Zt=5,We=1024,Jt=We*We,Gt=Zt*Jt,Xt=F.object({id:F.string(),title:F.string().min(1),content:F.string().min(1),image:F.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=Gt,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),ae=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Xt.safeParse({id:e.params.id,title:e.body.title,content:e.body.content,image:e.file});if(!r.success)return t.status(400).json({errors:F.prettifyError(r.error)});let{id:i,title:o,content:a,image:m}=r.data,n=await this.newsRepository.findById(i);if(!n)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});let p=e.user.id;if(n.author.id!==p)return t.status(401).json({message:"Sem permiss\xE3o."});let u;m&&n.imageUrl&&(u=await this.firebaseStorageService.updateFile({file:m,folder:C.NEWS,id:i,imageUrl:n.imageUrl}));let d=await this.newsRepository.update({id:i,title:o,content:a,imageUrl:u});t.status(200).json(d)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{getStorage as $t}from"firebase-admin/storage";import{config as Yt}from"dotenv";import Ze from"firebase-admin";Yt();var je=Ze.initializeApp({credential:Ze.credential.cert({clientEmail:l.FIREBASE_CLIENT_EMAIL,privateKey:l.FIREBASE_PRIVATE_KEY,projectId:l.FIREBASE_PROJECT_ID,type:l.FIREBASE_TYPE,privateKeyId:l.FIREBASE_PRIVATE_KEY_ID,clientId:l.FIREBASE_CLIENT_ID,authUri:l.FIREBASE_AUTH_URI,tokenUri:l.FIREBASE_TOKEN_URI,authProviderX509CertUrl:l.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,clientX509CertUrl:l.FIREBASE_CLIENT_X509_CERT_URL}),storageBucket:l.FIREBASE_BUCKET});je.name?console.log("\u{1F525} Firebase conectado com sucesso!"):console.error("\u274C Erro ao se conectar ao Firebase.");var Vt=$t(je),Je=Vt.bucket(l.FIREBASE_BUCKET);import{randomUUID as er}from"node:crypto";var tr=/\/images\/.+$/,ne=class{constructor(e){this.bucket=e}async uploadFile({file:e,folder:t,id:r}){let i=`${er()}-${e?.originalname}`,o=this.bucket.file(`images/${t}/${r}/${i}`);return await new Promise((a,m)=>{let n=o.createWriteStream({metadata:{contentType:e?.mimetype}});n.on("error",p=>{console.log(p),m(p)}),n.on("finish",async()=>{try{await o.makePublic();let p=`https://storage.googleapis.com/${this.bucket.name}/${o.name}`;a(p)}catch(p){console.error(p),m(p)}}),n.end(e.buffer)})}async updateFile({file:e,id:t,imageUrl:r,folder:i}){try{let o=this.getPath(r);if(!o)throw new Error("Arquivo n\xE3o encontrado.");let[a,m]=await Promise.all([this.bucket.file(o).delete(),this.uploadFile({file:e,id:t,folder:i})]);return m}catch(o){throw console.error(o),new Error("Erro ao atualizar o arquivo.")}}async deleteFile({imageUrl:e}){let t=this.getPath(e);if(!t)throw new Error("Arquivo n\xE3o encontrado.");try{await this.bucket.file(t).delete()}catch(r){throw console.error(r),new Error("Erro ao deletar o arquivo.")}}getPath(e){let t=e.match(tr);return t?t[0].slice(1):null}};function D(){return new ne(Je)}function Ge(){return{createNewsController:new te(U(),D())}}function Xe(){return{findAllNewsController:new ie(U())}}function Ye(){return{findNewsByIdController:new oe(U())}}function $e(){return{findNewsByAuthorIdController:new se(U())}}function Ve(){return{updateNewsController:new ae(U(),D())}}function et(){return{deleteNewsController:new re(U(),D())}}import tt from"multer";var H=tt({storage:tt.memoryStorage()});var A=rr(),{authMiddleware:Ne}=w();A.post("/",(s,e,t)=>{Ne.authenticated(s,e,t)},H.single("image"),async(s,e)=>{let{createNewsController:t}=Ge();await t.handle(s,e)});A.get("/",async(s,e)=>{let{findAllNewsController:t}=Xe();await t.handle(s,e)});A.get("/:id",async(s,e)=>{let{findNewsByIdController:t}=Ye();await t.handle(s,e)});A.get("/author/:authorId",async(s,e)=>{let{findNewsByAuthorIdController:t}=$e();await t.handle(s,e)});A.put("/:id",(s,e,t)=>{Ne.authenticated(s,e,t)},H.single("image"),async(s,e)=>{let{updateNewsController:t}=Ve();await t.handle(s,e)});A.delete("/:id",(s,e,t)=>{Ne.authenticated(s,e,t)},async(s,e)=>{let{deleteNewsController:t}=et();await t.handle(s,e)});import{Router as nr}from"express";import v from"zod";var sr=v.object({teamId:v.uuid(),member:v.object({userId:v.uuid(),role:v.string(),description:v.string()})}),me=class{constructor(e,t){this.teamMemberRepository=e;this.userRepository=t}async handle(e,t){try{let r=sr.safeParse({...e.body,teamId:e.params.teamId});if(!r.success)return t.status(400).json({errors:v.prettifyError(r.error)});let{teamId:i,member:{userId:o,...a}}=r.data;if(!await this.userRepository.findById(o))return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let n=await this.teamMemberRepository.create({...a,userId:o,teamId:i});t.status(201).json(n)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as xe}from"zod";var or=xe.object({id:xe.uuid()}),pe=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=or.safeParse(e.params);if(!r.success)return t.status(400).json({errors:xe.prettifyError(r.error)});let{id:i}=r.data;await this.teamMemberRepository.delete(i),t.status(200).json({message:"Membro removido com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Fe}from"zod";var ir=Fe.object({id:Fe.uuid()}),ce=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=ir.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Fe.prettifyError(r.error)});let{id:i}=r.data,o=await this.teamMemberRepository.findById(i);if(!o)return t.status(404).json({message:"Membro n\xE3o encontrado."});t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as M}from"zod";var ar=M.object({id:M.uuid(),role:M.string(),userId:M.string(),description:M.string()}),ue=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=ar.safeParse(e.body);if(!r.success)return t.status(400).json({errors:M.prettifyError(r.error)});let i=r.data,o=await this.teamMemberRepository.update(i);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var b=class{constructor(e){this.prisma=e}async findById(e){return await this.prisma.teamMember.findFirst({where:{id:e}})}async findByTeamId(e){return await this.prisma.teamMember.findMany({where:{teamId:e}})}async create({description:e,role:t,teamId:r,userId:i}){return await this.prisma.teamMember.create({data:{role:t,description:e,teamId:r,userId:i}})}async update({id:e,...t}){return await this.prisma.teamMember.update({where:{id:e},data:t})}async updateMany({members:e,teamId:t}){await Promise.all(e.map(async({user:r,role:i})=>{let o=await this.prisma.teamMember.findFirst({where:{teamId:t,userId:r.id},include:{user:!0}});o?await this.prisma.teamMember.update({where:{id:o.id},data:{role:i}}):await this.prisma.teamMember.create({data:{teamId:t,userId:r.id,role:i}})}))}async delete(e){await this.prisma.teamMember.deleteMany({where:{id:e}})}async deleteMany(e){await Promise.all(e.map(async t=>{await this.prisma.teamMember.delete({where:{id:t}})}))}};function rt(){return{createTeamMemberController:new me(new b(y),R())}}function st(){return{findTeamMemberController:new ce(new b(y))}}function ot(){return{updateTeamMemberController:new ue(new b(y))}}function it(){return{deleteTeamMemberController:new pe(new b(y))}}var k=nr(),{authMiddleware:de}=w();k.post("/:teamId/member",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{createTeamMemberController:t}=rt();await t.handle(s,e)});k.get("/member/:id",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{findTeamMemberController:t}=st();await t.handle(s,e)});k.put("/member/:id",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamMemberController:t}=ot();await t.handle(s,e)});k.delete("/member/:id",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamMemberController:t}=it();await t.handle(s,e)});import{Router as lr}from"express";import S from"zod";var mr=S.object({name:S.string().min(1),type:S.string().min(1),members:S.array(S.object({role:S.string().min(1),user:S.object({id:S.string()})}))}),le=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=mr.safeParse(e.body);if(!r.success)return t.status(400).json({errors:S.prettifyError(r.error)});let{name:i,type:o,members:a}=r.data,m=await this.teamRepository.create({name:i,type:o,members:a});t.status(201).json(m)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as De}from"zod";var pr=De.object({id:De.uuid()}),ye=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=pr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:De.prettifyError(r.error)});let{id:i}=r.data;await this.teamRepository.delete(i),t.status(200).json({message:"Equipe deletada com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Me}from"zod";var cr=Me.object({id:Me.uuid()}),fe=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=cr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Me.prettifyError(r.error)});let{id:i}=r.data,o=await this.teamRepository.findById(i);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Re}from"zod";var ur=Re.object({type:Re.string(),name:Re.string().optional()}),he=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=ur.safeParse({type:e.params.type,name:e.query.name});if(!r.success)return t.status(400).json({errors:Re.prettifyError?.(r.error)});let{type:i,name:o}=r.data,a=await this.teamRepository.findByType({type:i,filter:{name:o}});t.status(200).json(a)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var we=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=await this.teamRepository.findAll();return t.status(200).json(r)}catch(r){if(console.error(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import{z as I}from"zod";var dr=I.object({id:I.uuid(),name:I.string().min(1),members:I.array(I.object({role:I.string(),id:I.uuid(),user:I.object({id:I.uuid()})}))}),ge=class{constructor(e,t){this.teamRepository=e;this.teamMemberRepository=t}async handle(e,t){try{let r=dr.safeParse({id:e.params.id,...e.body});if(!r.success)return t.status(400).json({errors:I.prettifyError(r.error)});let{name:i,members:o,id:a}=r.data,m=await this.teamMemberRepository.findByTeamId(a),n=o.map(d=>d.id),p=m.filter(d=>!n.includes(d.id)).map(d=>d.id);await this.teamMemberRepository.deleteMany(p),await this.teamMemberRepository.updateMany({teamId:a,members:o});let u=await this.teamRepository.update({id:a,name:i});t.status(200).json(u)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var Ee=class{constructor(e){this.prisma=e}async create({members:e,name:t,type:r}){return await this.prisma.team.create({data:{name:t,type:r,members:{create:e.map(({description:i,role:o,user:a})=>({role:o,description:i,user:{connect:{id:a.id}}}))}}})}async findAll(){return await this.prisma.team.findMany({include:{members:{include:{user:!0}}}})}async findById(e){return await this.prisma.team.findUnique({where:{id:e},include:{members:{include:{user:!0}}}})}async findByType({type:e,filter:{name:t}}){let r={type:e};return t&&(r.name={contains:t,mode:"insensitive"}),await this.prisma.team.findMany({where:r,include:{members:{include:{user:!0}}}})}async update({id:e,name:t}){return await this.prisma.team.update({where:{id:e},data:{name:t}})}async delete(e){await this.prisma.team.delete({where:{id:e}})}};function j(){return new Ee(y)}function at(){return new b(y)}function nt(){return{findTeamsController:new we(j())}}function mt(){return{findTeamByIdController:new fe(j())}}function pt(){return{findTeamByTypeController:new he(j())}}function ct(){return{createTeamController:new le(j())}}function ut(){return{updateTeamController:new ge(j(),at())}}function dt(){return{deleteTeamController:new ye(j())}}var B=lr(),{authMiddleware:ke}=w();B.get("/",async(s,e)=>{let{findTeamsController:t}=nt();await t.handle(s,e)});B.get("/id/:id",async(s,e)=>{let{findTeamByIdController:t}=mt();await t.handle(s,e)});B.get("/type/:type",async(s,e)=>{let{findTeamByTypeController:t}=pt();await t.handle(s,e)});B.post("/",(s,e,t)=>{ke.isAdmin(s,e,t)},async(s,e)=>{let{createTeamController:t}=ct();await t.handle(s,e)});B.put("/:id",(s,e,t)=>{ke.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamController:t}=ut();await t.handle(s,e)});B.delete("/:id",(s,e,t)=>{ke.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamController:t}=dt();await t.handle(s,e)});import{Router as Ir}from"express";import lt from"zod";var yr=lt.object({id:lt.string()}),Ie=class{constructor(e){this.userRepository=e}async handle(e,t){try{let{id:r}=yr.parse(e.body),i=await this.userRepository.findById(r);if(!i)return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let o=e.user.id;return i.id!==o?t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para deletar o usu\xE1rio"}):(await this.userRepository.deleteById(i.id),t.status(200).json({message:"Usu\xE1rio deletado com sucesso!"}))}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Oe}from"zod";var fr=Oe.object({id:Oe.string().min(1,"id do usu\xE1rio n\xE3o fornecido.")}),Te=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=fr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Oe.treeifyError(r.error)});let{id:i}=r.data,o=await this.userRepository.findById(i);if(!o)return t.status(404).json({message:"Usu\xE1rio n\xE3o encontrado"});t.status(200).json(o)}catch(r){console.log(r),r instanceof Error&&t.status(400).json({message:"Erro ao buscar usu\xE1rio"})}}};var Ue=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=await this.userRepository.find();t.status(200).json(r)}catch(r){console.log(r),r instanceof Error&&t.status(400).json({message:"Erro ao buscar usu\xE1rios"})}}};import N from"zod";var ft=2,yt=1024,Rr=yt*yt,hr=ft*Rr,wr=/^\d{4}-\d{4}-\d{4}-\d{4}$/,be=/^[^0-9]*$/,gr=/^\(?\d{2}\)?[\s-]?\d{4,5}-?\d{4}$/,Er=N.object({name:N.string().optional(),lattesUrl:N.url().optional(),orcid:N.string().transform(s=>s.trim()).transform(s=>be.test(s)?"":s).refine(s=>be.test(s)||wr.test(s),{message:"ORCID inv\xE1lido. Deve estar no formato 0000-0000-0000-0000"}),phone:N.string().transform(s=>be.test(s)?"":s).refine(s=>be.test(s)||gr.test(s),{message:"Telefone inv\xE1lido. Deve estar no formato (99) 99999-9999"}),avatarImage:N.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=hr||typeof s=="string",{message:`A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo ${ft}MB.`})}),Se=class{constructor(e,t){this.userRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Er.safeParse({...e.body,avatarImage:e.file});if(!r.success)return t.status(400).json({errors:N.prettifyError(r.error)});let{name:i,lattesUrl:o,orcid:a,phone:m,avatarImage:n}=r.data,p=e.user.id,u,d=await this.userRepository.findById(p);return d?(n&&typeof n=="object"&&typeof n.size=="number"&&typeof n.mimetype=="string"&&(console.log(n),d.avatarUrl?u=await this.firebaseStorageService.updateFile({file:n,id:p,folder:C.USER,imageUrl:d.avatarUrl}):u=await this.firebaseStorageService.uploadFile({file:n,id:p,folder:C.USER})),await this.userRepository.update({id:p,avatarUrl:u,name:i,orcid:a,phone:m,lattesUrl:o}),t.status(200).json({message:"Usu\xE1rio atualizado com sucesso."})):t.status(400).json({message:"O usu\xE1rio n\xE3o existe"})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};function Rt(){return{updateUserController:new Se(R(),D())}}function ht(){return{deleteUserController:new Ie(R())}}function wt(){return{findUsersController:new Ue(R())}}function gt(){return{findUserController:new Te(R())}}var O=Ir(),{authMiddleware:Et}=w();O.get("/:id",async(s,e)=>{let{findUserController:t}=gt();await t.handle(s,e)});O.put("/",(s,e,t)=>{Et.authenticated(s,e,t)},H.single("avatarImage"),async(s,e)=>{let{updateUserController:t}=Rt();await t.handle(s,e)});O.delete("/",(s,e,t)=>{Et.authenticated(s,e,t)},async(s,e)=>{let{deleteUserController:t}=ht();await t.handle(s,e)});O.get("/",async(s,e)=>{let{findUsersController:t}=wt();await t.handle(s,e)});var h=qe(),Ur={methods:["GET","POST","PUT","DELETE"],origin:["http://localhost:3000","https://rede-ct.vercel.app"],credentials:!0};h.use(Tr(Ur));h.use(qe.json());h.use(qe.urlencoded({extended:!1}));h.use("/",_e);h.use("/auth",_);h.use("/user",O);h.use("/news",A);h.use("/team",B);h.use("/team",k);var Sr=br.createServer(h),It=4e3;Sr.listen(It,()=>{console.log(`\u{1F680} Aplica\xE7\xE3o rodando na porta ${It}.`)});

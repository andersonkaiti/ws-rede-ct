import ar from"node:http";import sr from"cors";import Ce from"express";import{Router as yt}from"express";import Q from"zod";var mt=Q.object({password:Q.string(),email:Q.email()}),H=class{constructor(e,t,r){this.userRepository=e;this.bcrypt=t;this.jwtService=r}async handle(e,t){try{let r=mt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:Q.prettifyError(r.error)});let{email:a,password:o}=r.data,i=await this.userRepository.findByEmail(a);if(!i)return t.status(401).json({message:"Usu\xE1rio n\xE3o existe."});if(!await this.bcrypt.compare({password:o,hashedPassword:i.passwordHash}))return t.status(401).json({message:"Senha inv\xE1lida."});let{id:n,role:p}=i,l=this.jwtService.sign({id:n,role:p,email:a});return t.status(200).json({token:l})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import M from"zod";var pt=M.object({name:M.string(),email:M.email(),password:M.string()}),K=class{constructor(e,t){this.userRepository=e;this.bcrypt=t}async handle(e,t){try{let r=pt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:M.prettifyError(r.error)});let{email:a,name:o,password:i}=r.data;if(await this.userRepository.findByEmail(a))return t.status(409).json({message:"Usu\xE1rio j\xE1 existe."});let n=await this.bcrypt.hash(i);return await this.userRepository.create({name:o,emailAddress:a,passwordHash:n}),t.status(201).json({message:"Usu\xE1rio criado com sucesso."})}catch(r){if(r instanceof Error)return t.status(400).json({message:r.message})}}};import{PrismaClient as ct}from"@prisma/client";var f=new ct({log:["query"]});var z=class{constructor(e){this.prisma=e}async create(e){await this.prisma.user.create({data:e})}async update(e){await this.prisma.user.update({where:{id:e.id},data:e})}async deleteById(e){await this.prisma.user.delete({where:{id:e}})}async find(){return await this.prisma.user.findMany({omit:{passwordHash:!0}})}async findByEmail(e){return await this.prisma.user.findFirst({where:{emailAddress:e}})}async findById(e){return await this.prisma.user.findFirst({where:{id:e}})}};function T(){return new z(f)}import{compare as ut,hash as lt}from"bcryptjs";var W=class{constructor(e,t){this.hashFn=e;this.compareFn=t}async hash(e){return await this.hashFn(e,6)}async compare({password:e,hashedPassword:t}){return await this.compareFn(e,t)}};function k(){return new W(lt,ut)}import _e from"jsonwebtoken";import d from"zod";var dt=d.object({JWT_SECRET:d.string(),FIREBASE_BUCKET:d.string(),FIREBASE_CLIENT_EMAIL:d.string(),FIREBASE_PRIVATE_KEY:d.string(),FIREBASE_PROJECT_ID:d.string(),FIREBASE_TYPE:d.string(),FIREBASE_PRIVATE_KEY_ID:d.string(),FIREBASE_CLIENT_ID:d.string(),FIREBASE_AUTH_URI:d.string(),FIREBASE_TOKEN_URI:d.string(),FIREBASE_AUTH_PROVIDER_X509_CERT_URL:d.string(),FIREBASE_CLIENT_X509_CERT_URL:d.string()}),u=dt.parse(process.env);var L=class{constructor(e,t){this.signFn=e;this.verifyFn=t}sign(e){try{return this.signFn(e,u.JWT_SECRET,{expiresIn:"3d",subject:e.id})}catch{return null}}verify(e){try{return this.verifyFn(e,u.JWT_SECRET)}catch{return null}}};function Z(){return new L(_e.sign,_e.verify)}function je(){return{signUpController:new K(T(),k())}}function xe(){return{signInController:new H(T(),k(),Z())}}var J=yt(),{signUpController:ft}=je(),{signInController:Rt}=xe();J.post("/sign-up",async(s,e)=>{await ft.handle(s,e)});J.post("/sign-in",async(s,e)=>{await Rt.handle(s,e)});import{Router as ht}from"express";var we=ht();we.get("/",(s,e)=>{e.status(200).json({message:"Rede CT"})});import{Router as Pt}from"express";import O from"zod";var x={NEWS:"news",USER:"user"};var wt=5,Ne=1024,gt=Ne*Ne,It=wt*gt,Et=O.object({title:O.string().min(1),content:O.string().min(1),image:O.any().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=It,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),Y=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Et.safeParse({...e.body,image:e.file});if(!r.success)return t.status(400).json({errors:O.prettifyError(r.error)});let{title:a,content:o,image:i}=r.data,m=e.user.id,n=await this.firebaseStorageService.uploadFile({file:i,folder:x.NEWS,id:m}),p=await this.newsRepository.create({title:a,content:o,authorId:m,imageUrl:n});t.status(201).json(p)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import ge from"zod";var Tt=ge.object({id:ge.string()}),V=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Tt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:ge.prettifyError(r.error)});let{id:a}=r.data,o=e.user.id,i=await this.newsRepository.findById(a);if(!i)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});if(i.author.id!==o)return t.status(401).json({message:"Sem permiss\xE3o."});await Promise.all([this.newsRepository.delete(a),this.firebaseStorageService.deleteFile({imageUrl:i.imageUrl})]),t.status(200).json({message:"Not\xEDcia deletada com sucesso."})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import g from"zod";var St=1,bt=7,Ut=g.object({page:g.coerce.number().min(1).default(St),limit:g.coerce.number().min(1).default(bt),authorId:g.string(),title:g.string().optional(),content:g.string().optional(),orderBy:g.union([g.enum(["asc","desc"]),g.literal("")]).optional().transform(s=>s===""?void 0:s)}),X=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Ut.safeParse({page:e.query.page,limit:e.query.limit,author_id:e.params.author_id,title:e.query.title,content:e.query.content,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:g.prettifyError(r.error)});let{page:a,limit:o,authorId:i,content:m,orderBy:n,title:p}=r.data,l=o*a-o,[w,R]=await Promise.all([this.newsRepository.findByAuthorId({authorId:i,pagination:{offset:l,limit:o},filter:{orderBy:n,title:p,content:m}}),this.newsRepository.count({filter:{authorId:i,content:m,title:p}})]),j=Math.ceil(R/o);t.status(200).json({page:a,totalPages:j,offset:l,limit:o,news:w})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Ie from"zod";var At=Ie.object({id:Ie.string()}),G=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=At.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ie.prettifyError(r.error)});let{id:a}=r.data,o=await this.newsRepository.findById(a);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import I from"zod";var vt=1,Bt=9,Ct=I.object({page:I.coerce.number().min(1).default(vt),limit:I.coerce.number().min(1).default(Bt),title:I.string().optional(),content:I.string().optional(),authorId:I.string().optional(),orderBy:I.union([I.enum(["asc","desc"]),I.literal("")]).optional().transform(s=>s===""?void 0:s)}),$=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Ct.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,author_id:e.query.author_id,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:I.prettifyError(r.error)});let{page:a,limit:o,authorId:i,content:m,orderBy:n="desc",title:p}=r.data,l=o*a-o,[w,R]=await Promise.all([this.newsRepository.find({pagination:{offset:l,limit:o},filter:{authorId:i,content:m,title:p,orderBy:n}}),this.newsRepository.count({filter:{title:p,content:m,authorId:i}})]),j=Math.min(Math.ceil(R/o),1);t.status(200).json({page:a,totalPages:j,offset:l,limit:o,news:w})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import N from"zod";var _t=5,Fe=1024,jt=Fe*Fe,xt=_t*jt,Nt=N.object({id:N.string(),title:N.string().min(1),content:N.string().min(1),image:N.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=xt,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),ee=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Nt.safeParse({id:e.params.id,title:e.body.title,content:e.body.content,image:e.file});if(!r.success)return t.status(400).json({errors:N.prettifyError(r.error)});let{id:a,title:o,content:i,image:m}=r.data,n=await this.newsRepository.findById(a);if(!n)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});let p=e.user.id;if(n.author.id!==p)return t.status(401).json({message:"Sem permiss\xE3o."});let l;m&&n.imageUrl&&(l=await this.firebaseStorageService.updateFile({file:m,folder:x.NEWS,id:a,imageUrl:n.imageUrl}));let w=await this.newsRepository.update({id:a,title:o,content:i,imageUrl:l});t.status(200).json(w)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var te=class{constructor(e){this.prisma=e}async create({authorId:e,...t}){return await this.prisma.news.create({data:{...t,author:{connect:{id:e}}}})}async find({pagination:{offset:e,limit:t},filter:{authorId:r,content:a,title:o,orderBy:i="desc"}}){let m={};r&&(m.authorId={contains:r,mode:"insensitive"});let n=[];return o&&n.push({title:{contains:o,mode:"insensitive"}}),a&&n.push({content:{contains:a,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({where:m,omit:{authorId:!0},include:{author:!0},orderBy:{updatedAt:i},skip:e,take:t})}async findById(e){return await this.prisma.news.findUnique({where:{id:e},omit:{authorId:!0},include:{author:!0}})}async findByAuthorId({authorId:e,pagination:{offset:t,limit:r},filter:{orderBy:a="desc",content:o,title:i}}){let m={authorId:e},n=[];return i&&n.push({title:{contains:i,mode:"insensitive"}}),o&&n.push({content:{contains:o,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({omit:{authorId:!0},where:m,orderBy:{updatedAt:a},skip:t,take:r})}async update(e){return await this.prisma.news.update({where:{id:e.id},data:{title:e.title,content:e.content,imageUrl:e.imageUrl}})}async delete(e){await this.prisma.news.delete({where:{id:e}})}async count({filter:{authorId:e,content:t,title:r}}){let a={};e&&(a.authorId={contains:e,mode:"insensitive"});let o=[];return r&&o.push({title:{contains:r,mode:"insensitive"}}),t&&o.push({content:{contains:t,mode:"insensitive"}}),o.length>0&&(a.OR=o),await this.prisma.news.count({where:a})}};function v(){return new te(f)}import{getStorage as Dt}from"firebase-admin/storage";import{config as Ft}from"dotenv";import De from"firebase-admin";Ft();var Ee=De.initializeApp({credential:De.credential.cert({clientEmail:u.FIREBASE_CLIENT_EMAIL,privateKey:u.FIREBASE_PRIVATE_KEY,projectId:u.FIREBASE_PROJECT_ID,type:u.FIREBASE_TYPE,privateKeyId:u.FIREBASE_PRIVATE_KEY_ID,clientId:u.FIREBASE_CLIENT_ID,authUri:u.FIREBASE_AUTH_URI,tokenUri:u.FIREBASE_TOKEN_URI,authProviderX509CertUrl:u.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,clientX509CertUrl:u.FIREBASE_CLIENT_X509_CERT_URL}),storageBucket:u.FIREBASE_BUCKET});Ee.name?console.log("\u{1F525} Firebase conectado com sucesso!"):console.error("\u274C Erro ao se conectar ao Firebase.");var Mt=Dt(Ee),Me=Mt.bucket(u.FIREBASE_BUCKET);import{randomUUID as kt}from"node:crypto";var Ot=/\/images\/.+$/,re=class{constructor(e){this.bucket=e}async uploadFile({file:e,folder:t,id:r}){let a=`${kt()}-${e?.originalname}`,o=this.bucket.file(`images/${t}/${r}/${a}`);return await new Promise((i,m)=>{let n=o.createWriteStream({metadata:{contentType:e?.mimetype}});n.on("error",p=>{console.log(p),m(p)}),n.on("finish",async()=>{try{await o.makePublic();let p=`https://storage.googleapis.com/${this.bucket.name}/${o.name}`;i(p)}catch(p){console.error(p),m(p)}}),n.end(e.buffer)})}async updateFile({file:e,id:t,imageUrl:r,folder:a}){try{let o=this.getPath(r);if(!o)throw new Error("Arquivo n\xE3o encontrado.");let[i,m]=await Promise.all([this.bucket.file(o).delete(),this.uploadFile({file:e,id:t,folder:a})]);return m}catch(o){throw console.error(o),new Error("Erro ao atualizar o arquivo.")}}async deleteFile({imageUrl:e}){let t=this.getPath(e);if(!t)throw new Error("Arquivo n\xE3o encontrado.");try{await this.bucket.file(t).delete()}catch(r){throw console.error(r),new Error("Erro ao deletar o arquivo.")}}getPath(e){let t=e.match(Ot);return t?t[0].slice(1):null}};function F(){return new re(Me)}function ke(){return{createNewsController:new Y(v(),F())}}function Oe(){return{findAllNewsController:new $(v())}}function Pe(){return{findNewsByIdController:new G(v())}}function qe(){return{findNewsByAuthorIdController:new X(v())}}function Qe(){return{updateNewsController:new ee(v(),F())}}function He(){return{deleteNewsController:new V(v(),F())}}var se=class{constructor(e){this.jwtService=e}authenticated(e,t,r){let a=e.headers.authorization;if(!a)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(a);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});e.user=o,r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}isAdmin(e,t,r){let a=e.headers.authorization;if(!a)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(a);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});if(o.role!=="ADMIN")return t.status(401).json({message:"\xC9 necess\xE1rio ter permiss\xF5es de administrador."});r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}};function S(){return{authMiddleware:new se(Z())}}import Ke from"multer";var Te=Ke({storage:Ke.memoryStorage()});var b=Pt(),{authMiddleware:Se}=S();b.post("/",(s,e,t)=>{Se.authenticated(s,e,t)},Te.single("image"),async(s,e)=>{let{createNewsController:t}=ke();await t.handle(s,e)});b.get("/",async(s,e)=>{let{findAllNewsController:t}=Oe();await t.handle(s,e)});b.get("/:id",async(s,e)=>{let{findNewsByIdController:t}=Pe();await t.handle(s,e)});b.get("/author/:authorId",async(s,e)=>{let{findNewsByAuthorIdController:t}=qe();await t.handle(s,e)});b.put("/:id",(s,e,t)=>{Se.authenticated(s,e,t)},Te.single("image"),async(s,e)=>{let{updateNewsController:t}=Qe();await t.handle(s,e)});b.delete("/:id",(s,e,t)=>{Se.authenticated(s,e,t)},async(s,e)=>{let{deleteNewsController:t}=He();await t.handle(s,e)});import{Router as Kt}from"express";import B from"zod";var qt=B.object({teamId:B.uuid(),member:B.object({userId:B.uuid(),role:B.string(),description:B.string()})}),oe=class{constructor(e,t){this.teamMemberRepository=e;this.userRepository=t}async handle(e,t){try{let r=qt.safeParse({...e.body,teamId:e.params});if(!r.success)return t.status(400).json({errors:B.prettifyError(r.error)});let{teamId:a,member:{userId:o,...i}}=r.data;if(!await this.userRepository.findById(o))return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let n=await this.teamMemberRepository.create({...i,userId:o,teamId:a});t.status(201).json(n)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as be}from"zod";var Qt=be.object({id:be.uuid()}),ae=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=Qt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:be.prettifyError(r.error)});let{id:a}=r.data;await this.teamMemberRepository.delete(a),t.status(200).json({message:"Membro removido com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as D}from"zod";var Ht=D.object({id:D.uuid(),role:D.string(),userId:D.string(),description:D.string()}),ie=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=Ht.safeParse(e.body);if(!r.success)return t.status(400).json({errors:D.prettifyError(r.error)});let a=r.data,o=await this.teamMemberRepository.update(a);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var U=class{constructor(e){this.prisma=e}async findByTeamId(e){return await this.prisma.teamMember.findMany({where:{teamId:e}})}async create(e){return await this.prisma.teamMember.create({data:e})}async update({id:e,...t}){return await this.prisma.teamMember.update({where:{id:e},data:t})}async updateMany({id:e,members:t}){await Promise.all(t.map(async r=>{let a=await this.prisma.teamMember.findFirst({where:{teamId:e,userId:r.user.id},include:{user:!0}});a?await this.prisma.teamMember.update({where:{id:a.id},data:{role:r.role}}):await this.prisma.teamMember.create({data:{teamId:e,userId:r.user.id,role:r.role}})}))}async delete(e){await this.prisma.teamMember.deleteMany({where:{id:e}})}async deleteMany(e){await Promise.all(e.map(async t=>{await this.prisma.teamMember.delete({where:{id:t}})}))}};function ze(){return{createTeamMemberController:new oe(new U(f),T())}}function We(){return{updateTeamMemberController:new ie(new U(f))}}function Le(){return{deleteTeamMemberController:new ae(new U(f))}}var P=Kt(),{authMiddleware:Ue}=S();P.put("/member/:id",(s,e,t)=>{Ue.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamMemberController:t}=We();await t.handle(s,e)});P.post("/:teamId/member",(s,e,t)=>{Ue.isAdmin(s,e,t)},async(s,e)=>{let{createTeamMemberController:t}=ze();await t.handle(s,e)});P.delete("/member/:id",(s,e,t)=>{Ue.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamMemberController:t}=Le();await t.handle(s,e)});import{Router as Vt}from"express";import E from"zod";var zt=E.object({name:E.string().min(1),type:E.string().min(1),members:E.array(E.object({role:E.string(),user:E.object({id:E.string(),name:E.string().min(1)})}))}),ne=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=zt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:E.prettifyError(r.error)});let{name:a,type:o,members:i}=r.data,m=await this.teamRepository.create({name:a,type:o,members:i});t.status(201).json(m)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Ae}from"zod";var Wt=Ae.object({id:Ae.uuid()}),me=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=Wt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ae.prettifyError(r.error)});let{id:a}=r.data;await this.teamRepository.delete(a),t.status(200).json({message:"Equipe deletada com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as ve}from"zod";var Lt=ve.object({id:ve.uuid()}),pe=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=Lt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:ve.prettifyError(r.error)});let{id:a}=r.data,o=await this.teamRepository.findById(a);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as ce}from"zod";var Zt=ce.object({type:ce.string(),name:ce.string().optional()}),ue=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=Zt.safeParse({type:e.params.type,name:e.query.name});if(!r.success)return t.status(400).json({errors:ce.prettifyError?.(r.error)});let{type:a,name:o}=r.data,i=await this.teamRepository.findByType({type:a,filter:{name:o}});t.status(200).json(i)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var le=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=await this.teamRepository.findAll();return t.status(200).json(r)}catch(r){if(console.error(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import{z as y}from"zod";var Jt=y.object({id:y.uuid()}),Yt=y.object({name:y.string().min(1),members:y.array(y.object({id:y.uuid(),role:y.string(),user:y.object({id:y.uuid(),name:y.string()})}))}),de=class{constructor(e,t){this.teamRepository=e;this.teamMemberRepository=t}async handle(e,t){try{let r=Jt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:y.prettifyError?.(r.error)});let a=Yt.safeParse(e.body);if(!a.success)return t.status(400).json({errors:y.prettifyError(a.error)});let{id:o}=r.data,{name:i,members:m}=a.data,n=await this.teamMemberRepository.findByTeamId(o),p=m.map(R=>R.id),l=n.filter(R=>!p.includes(R.id)).map(R=>R.id);await this.teamMemberRepository.deleteMany(l),await this.teamMemberRepository.updateMany({teamId:o,members:m});let w=await this.teamRepository.update({id:o,name:i});t.status(200).json(w)}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};var ye=class{constructor(e){this.prisma=e}async create({members:e,name:t,type:r}){return await this.prisma.team.create({data:{name:t,type:r,members:{create:e.map(a=>({role:a.role,user:{connect:{id:a.user.id}}}))}}})}async findAll(){return await this.prisma.team.findMany({include:{members:{include:{user:!0}}}})}async findById(e){return await this.prisma.team.findUnique({where:{id:e},include:{members:{include:{user:!0}}}})}async findByType({type:e,filter:{name:t}}){let r={type:e};return t&&(r.name={contains:t,mode:"insensitive"}),await this.prisma.team.findMany({where:r,include:{members:{include:{user:!0}}}})}async update({id:e,name:t}){return await this.prisma.team.update({where:{id:e},data:{name:t}})}async delete(e){await this.prisma.team.delete({where:{id:e}})}};function C(){return new ye(f)}function Ze(){return new U(f)}function Je(){return{findTeamsController:new le(C())}}function Ye(){return{findTeamByIdController:new pe(C())}}function Ve(){return{findTeamByTypeController:new ue(C())}}function Xe(){return{createTeamController:new ne(C())}}function Ge(){return{updateTeamController:new de(C(),Ze())}}function $e(){return{deleteTeamController:new me(C())}}var A=Vt(),{authMiddleware:Be}=S();A.get("/",async(s,e)=>{let{findTeamsController:t}=Je();await t.handle(s,e)});A.get("/id/:id",async(s,e)=>{let{findTeamByIdController:t}=Ye();await t.handle(s,e)});A.get("/type/:type",async(s,e)=>{let{findTeamByTypeController:t}=Ve();await t.handle(s,e)});A.post("/",(s,e,t)=>{Be.isAdmin(s,e,t)},async(s,e)=>{let{createTeamController:t}=Xe();await t.handle(s,e)});A.put("/:id",(s,e,t)=>{Be.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamController:t}=Ge();await t.handle(s,e)});A.delete("/:id",(s,e,t)=>{Be.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamController:t}=$e();await t.handle(s,e)});import{Router as rr}from"express";import et from"zod";var Xt=et.object({id:et.string()}),fe=class{constructor(e){this.userRepository=e}async handle(e,t){try{let{id:r}=Xt.parse(e.body),a=await this.userRepository.findById(r);if(!a)return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let o=e.user.id;return a.id!==o?t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para deletar o usu\xE1rio"}):(await this.userRepository.deleteById(a.id),t.status(200).json({message:"Usu\xE1rio deletado com sucesso!"}))}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};var Re=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=await this.userRepository.find();t.status(200).json(r)}catch(r){console.log(r),r instanceof Error&&t.status(400).json({message:"Erro ao buscar usu\xE1rios"})}}};import{UserRole as rt}from"@prisma/client";import _ from"zod";var Gt=5,tt=1024,$t=tt*tt,er=Gt*$t,tr=_.object({id:_.uuid(),name:_.string().optional(),password:_.string().optional(),role:_.enum(rt).optional(),avatarImage:_.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=er,{message:"O avatar deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."}).optional()}),he=class{constructor(e,t,r){this.userRepository=e;this.firebaseStorageService=t;this.bcryptService=r}async handle(e,t){try{let r=tr.safeParse({...e.body,avatarImage:e.file});if(!r.success)return t.status(400).json({errors:_.prettifyError(r.error)});let{id:a,name:o,role:i,password:m,avatarImage:n}=r.data;if(e.user.id!==a)return t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para atualizar o usu\xE1rio."});let l;m&&(l=await this.bcryptService.hash(m));let w;n&&(w=await this.firebaseStorageService.uploadFile({file:n,id:a,folder:x.USER}));let R=e.user.role,j;return R===rt.ADMIN&&(j=i),await this.userRepository.update({avatarUrl:w,id:a,name:o,passwordHash:l,role:j}),t.status(200).json({message:"Usu\xE1rio atualizado com sucesso."})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};function st(){return{updateUserController:new he(T(),F(),k())}}function ot(){return{deleteUserController:new fe(T())}}function at(){return{findAllUsersController:new Re(T())}}var q=rr(),{authMiddleware:it}=S();q.put("/",(s,e,t)=>{it.authenticated(s,e,t)},async(s,e)=>{let{updateUserController:t}=st();await t.handle(s,e)});q.delete("/",(s,e,t)=>{it.authenticated(s,e,t)},async(s,e)=>{let{deleteUserController:t}=ot();await t.handle(s,e)});q.get("/",async(s,e)=>{let{findAllUsersController:t}=at();await t.handle(s,e)});var h=Ce(),or={methods:["GET","POST","PUT","DELETE"],origin:["http://localhost:3000","https://rede-ct.vercel.app"],credentials:!0};h.use(sr(or));h.use(Ce.json());h.use(Ce.urlencoded({extended:!1}));h.use("/",we);h.use("/auth",J);h.use("/user",q);h.use("/news",b);h.use("/team",A);h.use("/team",P);var ir=ar.createServer(h),nt=4e3;ir.listen(nt,()=>{console.log(`\u{1F680} Aplica\xE7\xE3o rodando na porta ${nt}.`)});

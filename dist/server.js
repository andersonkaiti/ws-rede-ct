import he from"node:http";import B from"express";import we from"cors";import{Router as ee}from"express";var T=ee();T.get("/",(o,e)=>{e.status(200).json({message:"Rede CT"})});import{Router as oe}from"express";import{ClerkExpressWithAuth as re}from"@clerk/clerk-sdk-node";var te=re(),D=(o,e,r)=>te(o,e,r);var d=class{async handle(e,r){let t=e.auth;if(!t||!t.userId){r.status(401).json({message:"N\xE3o autenticado"});return}r.status(200).json({message:"Usu\xE1rio autenticado com Clerk",userId:t.userId})}};function W(){return{clerkAuthController:new d}}var q=oe();q.get("/",D,async(o,e)=>{let{clerkAuthController:r}=W();await r.handle(o,e)});import{Router as ne}from"express";var y=class{constructor(e,r){this.clerkWebhookService=e;this.userRepository=r}async handle(e,r){try{let t=await this.clerkWebhookService.verifyEvent(e);if(!t)throw new Error("Erro ao verificar webhook.");let{type:s,data:{created_at:i,birthday:a,last_sign_in_at:n,updated_at:u,email_addresses:F,...Z}}=t;s==="user.created"&&(await this.userRepository.create({created_at:new Date(i),updated_at:new Date(u),email_addresses:F,...Z}),r.status(201).json({message:"Usu\xE1rio criado com sucesso."}))}catch(t){t instanceof Error&&r.status(400).json({message:t.message})}}};var f=class{constructor(e,r){this.clerkWebhookService=e;this.userRepository=r}async handle(e,r){try{let t=await this.clerkWebhookService.verifyEvent(e);if(!t)throw new Error("Erro ao verificar webhook.");let{type:s,data:i}=t;s==="user.deleted"&&(await this.userRepository.delete(i),r.status(200).json({message:"Usu\xE1rio deletado com sucesso."}))}catch(t){t instanceof Error&&r.status(400).json({message:t.message})}}};var w=class{constructor(e,r){this.clerkWebhookService=e;this.userRepository=r}async handle(e,r){try{let t=await this.clerkWebhookService.verifyEvent(e);if(!t)throw new Error("Erro ao verificar webhook.");let{type:s,data:{email_addresses:i,...a}}=t;s==="user.updated"&&(await this.userRepository.update({...a,email_addresses:i}),r.status(200).json({message:"Usu\xE1rio atualizado com sucesso."}))}catch(t){t instanceof Error&&r.status(400).json({message:t.message})}}};var R=class{constructor(e){this.prisma=e}async create({email_addresses:e,first_name:r,last_name:t,...s}){await this.prisma.user.create({data:{first_name:r,last_name:t,id:s.id,created_at:s.created_at,updated_at:s.updated_at,image_url:s.image_url,profile_image_url:s.profile_image_url,email_addresses:{create:e.map(i=>({email_address:i.email_address,linked_to:JSON.stringify(i.linked_to),id:i.id}))}}})}async update(e){await this.prisma.user.update({where:{id:e.id},data:{first_name:e.first_name,last_name:e.last_name,image_url:e.image_url,profile_image_url:e.profile_image_url,email_addresses:{update:e.email_addresses.map(r=>({where:{id:r.id},data:{email_address:r.email_address,linked_to:JSON.stringify(r.linked_to)}}))}}})}async delete(e){await this.prisma.user.delete({where:{id:e.id}})}};import{PrismaClient as se}from"@prisma/client";var h=new se;function g(){return new R(h)}import{Webhook as ie}from"svix";var v=class{constructor(e){this.webhook=e}async verifyEvent(e){let{"svix-id":r,"svix-timestamp":t,"svix-signature":s}=e.headers;if(!r||!t||!s)throw new Error("Headers are missing");let i=JSON.stringify(e.body),a={"svix-id":r,"svix-timestamp":t,"svix-signature":s};try{return this.webhook.verify(i,a)}catch(n){if(n instanceof Error)throw new Error(n.message)}}};function k(o){return new v(new ie(o))}import{config as ae}from"dotenv";ae();function O(){return{createUserController:new y(k(process.env.CLERK_USER_CREATED),g())}}function L(){return{updateUserController:new w(k(process.env.CLERK_USER_UPDATED),g())}}function K(){return{deleteUserController:new f(k(process.env.CLERK_USER_DELETED),g())}}var{createUserController:pe}=O(),{updateUserController:ce}=L(),{deleteUserController:le}=K(),m=ne();m.post("/api/webhook/created-user",async(o,e)=>{await pe.handle(o,e)});m.post("/api/webhook/updated-user",async(o,e)=>{await ce.handle(o,e)});m.post("/api/webhook/deleted-user",async(o,e)=>{await le.handle(o,e)});import{Router as fe}from"express";var I={NEWS:"news"};var E=class{constructor(e,r){this.newsRepository=e;this.firebaseStorageService=r}async handle(e,r){try{let{title:t,content:s,author_id:i}=e.body,a=await this.firebaseStorageService.uploadFile(e,I.NEWS),n=await this.newsRepository.create({title:t,content:s,author_id:i,image_url:a});r.status(201).json(n)}catch(t){t instanceof Error&&r.status(500).json({message:t.message})}}};var _=class{constructor(e,r){this.newsRepository=e;this.firebaseStorageService=r}async handle(e,r){try{let{id:t}=e.params,{title:s,content:i,image_url:a}=e.body,n;a&&(n=await this.firebaseStorageService.updateFile(e,I.NEWS));let u=await this.newsRepository.update({id:t,title:s,content:i,image_url:n});r.status(200).json(u)}catch(t){t instanceof Error&&r.status(500).json({message:t.message})}}};var C=class{constructor(e,r){this.newsRepository=e;this.firebaseStorageService=r}async handle(e,r){try{let{id:t}=e.params;await Promise.all([this.newsRepository.delete(t),this.firebaseStorageService.deleteFile(e)]),r.status(200).json({message:"Not\xEDcia deletada com sucesso."})}catch(t){t instanceof Error&&r.status(500).json({message:t.message})}}};var S=class{constructor(e){this.prisma=e}async create({title:e,content:r,author_id:t,image_url:s}){return await this.prisma.news.create({data:{title:e,content:r,author_id:t,image_url:s},include:{author:!0}})}async findAll(){return await this.prisma.news.findMany({include:{author:!0}})}async findById(e){return await this.prisma.news.findUnique({where:{id:e},include:{author:!0}})}async findByAuthorId(e){return await this.prisma.news.findMany({where:{author_id:e}})}async update(e){return await this.prisma.news.update({where:{id:e.id},data:{title:e.title,content:e.content,...e.image_url&&{image_url:e.image_url}}})}async delete(e){await this.prisma.news.delete({where:{id:e}})}};function l(){return new S(h)}var b=class{constructor(e){this.newsRepository=e}async handle(e,r){try{let t=await this.newsRepository.findAll();r.status(200).json(t)}catch(t){t instanceof Error&&r.status(500).json({message:t.message})}}};var U=class{constructor(e){this.newsRepository=e}async handle(e,r){try{let{id:t}=e.params,s=await this.newsRepository.findById(t);r.status(200).json(s)}catch(t){t instanceof Error&&r.status(500).json({message:t.message})}}};var N=class{constructor(e){this.newsRepository=e}async handle(e,r){try{let{author_id:t}=e.params,s=await this.newsRepository.findByAuthorId(t);r.status(200).json(s)}catch(t){t instanceof Error&&r.status(500).json({message:t.message})}}};import{randomUUID as me}from"node:crypto";var x=class{constructor(e){this.bucket=e}async uploadFile(e,r){if(!e.file)throw new Error("Arquivo n\xE3o encontrado.");let t=e.file,s=e.body.author_id,i=`${me()}-${t?.originalname}`,a=this.bucket.file(`images/${r}/${s}/${i}`),n=a.createWriteStream({metadata:{contentType:t?.mimetype}});return n.on("error",F=>{console.log(F)}),n.on("finish",async()=>{await a.makePublic()}),n.end(t?.buffer),`https://storage.googleapis.com/${this.bucket.name}/${a.name}`}async updateFile(e,r){if(!e.file)throw new Error("Arquivo n\xE3o encontrado.");try{let t=this.getPath(e.body.image_url);if(!t)throw new Error("Arquivo n\xE3o encontrado.");let[s,i]=await Promise.all([this.bucket.file(t).delete(),this.uploadFile(e,r)]);return i}catch{throw new Error("Erro ao atualizar o arquivo.")}}async deleteFile(e){if(!e.body.image_url)throw new Error("Arquivo n\xE3o encontrado.");let r=this.getPath(e.body.image_url);if(!r)throw new Error("Arquivo n\xE3o encontrado.");try{await this.bucket.file(r).delete()}catch{throw new Error("Erro ao deletar o arquivo.")}}getPath(e){let r=e.match(/\/images\/.+$/);return r?r[0].slice(1):null}};import $ from"firebase-admin";import{config as ue}from"dotenv";ue();var P=$.initializeApp({credential:$.credential.cert({clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:process.env.FIREBASE_PRIVATE_KEY,projectId:process.env.FIREBASE_PROJECT_ID,type:process.env.FIREBASE_TYPE,privateKeyId:process.env.FIREBASE_PRIVATE_KEY_ID,clientId:process.env.FIREBASE_CLIENT_ID,authUri:process.env.FIREBASE_AUTH_URI,tokenUri:process.env.FIREBASE_TOKEN_URI,authProviderX509CertUrl:process.env.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,clientX509CertUrl:process.env.FIREBASE_CLIENT_X509_CERT_URL}),storageBucket:process.env.FIREBASE_BUCKET});P.name?console.log("\u{1F525} Firebase conectado com sucesso!"):console.error("\u274C Erro ao se conectar ao Firebase.");import{getStorage as de}from"firebase-admin/storage";var ye=de(P),M=ye.bucket(process.env.FIREBASE_BUCKET);function A(){return new x(M)}function J(){return{createNewsController:new E(l(),A())}}function X(){return{findAllNewsController:new b(l())}}function z(){return{findNewsByIdController:new U(l())}}function H(){return{findNewsByAuthorIdController:new N(l())}}function V(){return{updateNewsController:new _(l(),A())}}function Y(){return{deleteNewsController:new C(l(),A())}}import G from"multer";var j=G({storage:G.memoryStorage()});var c=fe();c.post("/",j.single("image"),async(o,e)=>{let{createNewsController:r}=J();await r.handle(o,e)});c.get("/",async(o,e)=>{let{findAllNewsController:r}=X();await r.handle(o,e)});c.get("/:id",async(o,e)=>{let{findNewsByIdController:r}=z();await r.handle(o,e)});c.get("/author/:author_id",async(o,e)=>{let{findNewsByAuthorIdController:r}=H();await r.handle(o,e)});c.put("/:id",j.single("image"),async(o,e)=>{let{updateNewsController:r}=V();await r.handle(o,e)});c.delete("/:id",async(o,e)=>{let{deleteNewsController:r}=Y();await r.handle(o,e)});var p=B(),Re={methods:["GET","POST","PUT","DELETE"],origin:["http://localhost:3000","https://rede-ct.vercel.app"],credentials:!0};p.use(we(Re));p.use(B.json());p.use(B.urlencoded({extended:!1}));p.use("/",T);p.use("/auth",q);p.use("/user",m);p.use("/news",c);var ge=he.createServer(p),Q=4e3;ge.listen(Q,()=>{console.log(`\u{1F680} Aplica\xE7\xE3o rodando na porta ${Q}.`)});
//# sourceMappingURL=server.js.map
import wr from"node:http";import Rr from"cors";import Me from"express";import{Router as Bt}from"express";var K=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=e.user.id,i=await this.userRepository.findById(r);return i?t.status(200).json(i):t.status(404).json({message:"Usu\xE1rio n\xE3o encontrado."})}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};import T from"zod";var wt=1,gt=7,Et=T.object({page:T.coerce.number().min(1).default(wt),limit:T.coerce.number().min(1).default(gt),title:T.string().optional(),content:T.string().optional(),orderBy:T.union([T.enum(["asc","desc"]),T.literal("")]).optional().transform(s=>s===""?void 0:s)}),z=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Et.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:T.prettifyError(r.error)});let{page:i,limit:o,content:a,orderBy:m,title:n}=r.data,p=o*i-o,u=e.user.id,[l,_]=await Promise.all([this.newsRepository.findByAuthorId({authorId:u,pagination:{offset:p,limit:o},filter:{orderBy:m,title:n,content:a}}),this.newsRepository.count({filter:{authorId:u,content:a,title:n}})]),A=Math.ceil(_/o);t.status(200).json({page:i,totalPages:A,offset:p,limit:o,news:l})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import L from"zod";var It=L.object({password:L.string(),email:L.email()}),W=class{constructor(e,t,r){this.userRepository=e;this.bcrypt=t;this.jwtService=r}async handle(e,t){try{let r=It.safeParse(e.body);if(!r.success)return t.status(400).json({errors:L.prettifyError(r.error)});let{email:i,password:o}=r.data,a=await this.userRepository.findByEmail(i);if(!a)return t.status(401).json({message:"Usu\xE1rio n\xE3o existe."});if(!await this.bcrypt.compare({password:o,hashedPassword:a.passwordHash}))return t.status(401).json({message:"Senha inv\xE1lida."});let{id:n,role:p}=a,u=this.jwtService.sign({id:n,role:p,email:i});return t.status(200).json({token:u})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import x from"zod";var Z=8,Tt=x.object({name:x.string("Nome \xE9 obrigat\xF3rio.").min(1,"Nome \xE9 obrigat\xF3rio."),email:x.email("E-mail inv\xE1lido.").min(1,"E-mail \xE9 obrigat\xF3rio."),password:x.string("A senha \xE9 obrigat\xF3ria.").min(Z,`A senha deve ter pelo menos ${Z} caracteres.`),confirmPassword:x.string("A senha \xE9 obrigat\xF3ria.").min(Z,`A senha deve ter pelo menos ${Z} caracteres.`)}).refine(s=>s.password===s.confirmPassword,{message:"As senhas n\xE3o coincidem.",path:["confirmPassword"]}),J=class{constructor(e,t){this.userRepository=e;this.bcrypt=t}async handle(e,t){try{let r=Tt.safeParse(e.body);if(!r.success)return t.status(400).json({errors:x.prettifyError(r.error)});let{email:i,name:o,password:a}=r.data;if(await this.userRepository.findByEmail(i))return t.status(400).json({message:"Usu\xE1rio j\xE1 existe."});let n=await this.bcrypt.hash(a);return await this.userRepository.create({name:o,emailAddress:i,passwordHash:n}),t.status(201).json({message:"Usu\xE1rio criado com sucesso."})}catch(r){if(r instanceof Error)return t.status(400).json({message:r.message})}}};import{PrismaClient as bt}from"@prisma/client";var y=new bt({log:["query"]});var Y=class{constructor(e){this.prisma=e}async create({authorId:e,...t}){return await this.prisma.news.create({data:{...t,author:{connect:{id:e}}}})}async find({pagination:{offset:e,limit:t},filter:{authorId:r,content:i,title:o,orderBy:a="desc"}}){let m={};r&&(m.authorId={contains:r,mode:"insensitive"});let n=[];return o&&n.push({title:{contains:o,mode:"insensitive"}}),i&&n.push({content:{contains:i,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({where:m,omit:{authorId:!0},include:{author:!0},orderBy:{updatedAt:a},skip:e,take:t})}async findById(e){return await this.prisma.news.findUnique({where:{id:e},omit:{authorId:!0},include:{author:!0}})}async findByAuthorId({authorId:e,pagination:{offset:t,limit:r},filter:{orderBy:i="desc",content:o,title:a}}){let m={authorId:e},n=[];return a&&n.push({title:{contains:a,mode:"insensitive"}}),o&&n.push({content:{contains:o,mode:"insensitive"}}),n.length>0&&(m.OR=n),await this.prisma.news.findMany({omit:{authorId:!0},where:m,orderBy:{updatedAt:i},skip:t,take:r})}async update(e){return await this.prisma.news.update({where:{id:e.id},data:{title:e.title,content:e.content,imageUrl:e.imageUrl}})}async delete(e){await this.prisma.news.delete({where:{id:e}})}async count({filter:{authorId:e,content:t,title:r}}){let i={};e&&(i.authorId={contains:e,mode:"insensitive"});let o=[];return r&&o.push({title:{contains:r,mode:"insensitive"}}),t&&o.push({content:{contains:t,mode:"insensitive"}}),o.length>0&&(i.OR=o),await this.prisma.news.count({where:i})}};function b(){return new Y(y)}var G=class{constructor(e){this.prisma=e}async create(e){await this.prisma.user.create({data:e})}async update(e){await this.prisma.user.update({where:{id:e.id},data:e})}async deleteById(e){await this.prisma.user.delete({where:{id:e}})}async find(){return await this.prisma.user.findMany({omit:{passwordHash:!0}})}async findByEmail(e){return await this.prisma.user.findFirst({where:{emailAddress:e}})}async findById(e){return await this.prisma.user.findFirst({where:{id:e}})}};function h(){return new G(y)}import{compare as Ut,hash as St}from"bcryptjs";var V=class{constructor(e,t){this.hashFn=e;this.compareFn=t}async hash(e){return await this.hashFn(e,6)}async compare({password:e,hashedPassword:t}){return await this.compareFn(e,t)}};function P(){return new V(St,Ut)}import De from"jsonwebtoken";import f from"zod";var At=f.object({JWT_SECRET:f.string(),FIREBASE_BUCKET:f.string(),FIREBASE_CLIENT_EMAIL:f.string(),FIREBASE_PRIVATE_KEY:f.string(),FIREBASE_PROJECT_ID:f.string(),FIREBASE_TYPE:f.string(),FIREBASE_PRIVATE_KEY_ID:f.string(),FIREBASE_CLIENT_ID:f.string(),FIREBASE_AUTH_URI:f.string(),FIREBASE_TOKEN_URI:f.string(),FIREBASE_AUTH_PROVIDER_X509_CERT_URL:f.string(),FIREBASE_CLIENT_X509_CERT_URL:f.string()}),d=At.parse(process.env);var X=class{constructor(e,t){this.signFn=e;this.verifyFn=t}sign(e){try{return this.signFn(e,d.JWT_SECRET,{expiresIn:"3d",subject:e.id})}catch{return null}}verify(e){try{return this.verifyFn(e,d.JWT_SECRET)}catch{return null}}};function $(){return new X(De.sign,De.verify)}function ke(){return{signUpController:new J(h(),P())}}function Oe(){return{signInController:new W(h(),P(),$())}}function qe(){return{findAuthenticatedUserController:new K(h())}}function Pe(){return{findAuthenticatedUserController:new z(b())}}var ee=class{constructor(e){this.jwtService=e}authenticated(e,t,r){let i=e.headers.authorization;if(!i)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(i);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});e.user=o,r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}isAdmin(e,t,r){let i=e.headers.authorization;if(!i)return t.status(401).json({message:"Token n\xE3o fornecido."});try{let o=this.jwtService.verify(i);if(!o)return t.status(401).json({message:"Token inv\xE1lido."});if(o.role!=="ADMIN")return t.status(401).json({message:"\xC9 necess\xE1rio ter permiss\xF5es de administrador."});r()}catch(o){if(console.log(o),o instanceof Error)return t.status(401).json({message:o.message})}}};function w(){return{authMiddleware:new ee($())}}var F=Bt(),{signUpController:vt}=ke(),{signInController:_t}=Oe(),{authMiddleware:Qe}=w();F.post("/sign-up",async(s,e)=>{await vt.handle(s,e)});F.post("/sign-in",async(s,e)=>{await _t.handle(s,e)});F.get("/user",(s,e,t)=>{Qe.authenticated(s,e,t)},async(s,e)=>{let{findAuthenticatedUserController:t}=qe();await t.handle(s,e)});F.get("/user/news",(s,e,t)=>{Qe.authenticated(s,e,t)},async(s,e)=>{let{findAuthenticatedUserController:t}=Pe();await t.handle(s,e)});import{Router as Ct}from"express";var Ue=Ct();Ue.get("/",(s,e)=>{e.status(200).json({message:"Rede CT"})});import{Router as Xt}from"express";import Q from"zod";var M={NEWS:"news",USER:"user"};var jt=5,He=1024,Nt=He*He,xt=jt*Nt,Ft=Q.object({title:Q.string().min(1),content:Q.string().min(1),image:Q.any().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=xt,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),te=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Ft.safeParse({...e.body,image:e.file});if(!r.success)return t.status(400).json({errors:Q.prettifyError(r.error)});let{title:i,content:o,image:a}=r.data,m=e.user.id,n=await this.firebaseStorageService.uploadFile({file:a,folder:M.NEWS,id:m}),p=await this.newsRepository.create({title:i,content:o,authorId:m,imageUrl:n});t.status(201).json(p)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Se from"zod";var Mt=Se.object({id:Se.string()}),re=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Mt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Se.prettifyError(r.error)});let{id:i}=r.data,o=e.user.id,a=await this.newsRepository.findById(i);if(!a)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});if(a.author.id!==o)return t.status(401).json({message:"Sem permiss\xE3o."});await Promise.all([this.newsRepository.delete(i),this.firebaseStorageService.deleteFile({imageUrl:a.imageUrl})]),t.status(200).json({message:"Not\xEDcia deletada com sucesso."})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import g from"zod";var Dt=1,kt=7,Ot=g.object({page:g.coerce.number().min(1).default(Dt),limit:g.coerce.number().min(1).default(kt),authorId:g.string(),title:g.string().optional(),content:g.string().optional(),orderBy:g.union([g.enum(["asc","desc"]),g.literal("")]).optional().transform(s=>s===""?void 0:s)}),se=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Ot.safeParse({page:e.query.page,limit:e.query.limit,author_id:e.params.author_id,title:e.query.title,content:e.query.content,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:g.prettifyError(r.error)});let{page:i,limit:o,authorId:a,content:m,orderBy:n,title:p}=r.data,u=o*i-o,[l,_]=await Promise.all([this.newsRepository.findByAuthorId({authorId:a,pagination:{offset:u,limit:o},filter:{orderBy:n,title:p,content:m}}),this.newsRepository.count({filter:{authorId:a,content:m,title:p}})]),A=Math.ceil(_/o);t.status(200).json({page:i,totalPages:A,offset:u,limit:o,news:l})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import Ae from"zod";var qt=Ae.object({id:Ae.string()}),oe=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=qt.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ae.prettifyError(r.error)});let{id:i}=r.data,o=await this.newsRepository.findById(i);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import E from"zod";var Pt=1,Qt=9,Ht=E.object({page:E.coerce.number().min(1).default(Pt),limit:E.coerce.number().min(1).default(Qt),title:E.string().optional(),content:E.string().optional(),authorId:E.string().optional(),orderBy:E.union([E.enum(["asc","desc"]),E.literal("")]).optional().transform(s=>s===""?void 0:s)}),ie=class{constructor(e){this.newsRepository=e}async handle(e,t){try{let r=Ht.safeParse({page:e.query.page,limit:e.query.limit,title:e.query.title,content:e.query.content,author_id:e.query.author_id,order_by:e.query.order_by});if(!r.success)return t.status(400).json({errors:E.prettifyError(r.error)});let{page:i,limit:o,authorId:a,content:m,orderBy:n="desc",title:p}=r.data,u=o*i-o,[l,_]=await Promise.all([this.newsRepository.find({pagination:{offset:u,limit:o},filter:{authorId:a,content:m,title:p,orderBy:n}}),this.newsRepository.count({filter:{title:p,content:m,authorId:a}})]),A=Math.min(Math.ceil(_/o),1);t.status(200).json({page:i,totalPages:A,offset:u,limit:o,news:l})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import D from"zod";var Kt=5,Ke=1024,zt=Ke*Ke,Lt=Kt*zt,Wt=D.object({id:D.string(),title:D.string().min(1),content:D.string().min(1),image:D.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=Lt,{message:"A imagem deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."})}),ae=class{constructor(e,t){this.newsRepository=e;this.firebaseStorageService=t}async handle(e,t){try{let r=Wt.safeParse({id:e.params.id,title:e.body.title,content:e.body.content,image:e.file});if(!r.success)return t.status(400).json({errors:D.prettifyError(r.error)});let{id:i,title:o,content:a,image:m}=r.data,n=await this.newsRepository.findById(i);if(!n)return t.status(404).json({message:"Not\xEDcia n\xE3o encontrada."});let p=e.user.id;if(n.author.id!==p)return t.status(401).json({message:"Sem permiss\xE3o."});let u;m&&n.imageUrl&&(u=await this.firebaseStorageService.updateFile({file:m,folder:M.NEWS,id:i,imageUrl:n.imageUrl}));let l=await this.newsRepository.update({id:i,title:o,content:a,imageUrl:u});t.status(200).json(l)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{getStorage as Jt}from"firebase-admin/storage";import{config as Zt}from"dotenv";import ze from"firebase-admin";Zt();var Be=ze.initializeApp({credential:ze.credential.cert({clientEmail:d.FIREBASE_CLIENT_EMAIL,privateKey:d.FIREBASE_PRIVATE_KEY,projectId:d.FIREBASE_PROJECT_ID,type:d.FIREBASE_TYPE,privateKeyId:d.FIREBASE_PRIVATE_KEY_ID,clientId:d.FIREBASE_CLIENT_ID,authUri:d.FIREBASE_AUTH_URI,tokenUri:d.FIREBASE_TOKEN_URI,authProviderX509CertUrl:d.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,clientX509CertUrl:d.FIREBASE_CLIENT_X509_CERT_URL}),storageBucket:d.FIREBASE_BUCKET});Be.name?console.log("\u{1F525} Firebase conectado com sucesso!"):console.error("\u274C Erro ao se conectar ao Firebase.");var Yt=Jt(Be),Le=Yt.bucket(d.FIREBASE_BUCKET);import{randomUUID as Gt}from"node:crypto";var Vt=/\/images\/.+$/,ne=class{constructor(e){this.bucket=e}async uploadFile({file:e,folder:t,id:r}){let i=`${Gt()}-${e?.originalname}`,o=this.bucket.file(`images/${t}/${r}/${i}`);return await new Promise((a,m)=>{let n=o.createWriteStream({metadata:{contentType:e?.mimetype}});n.on("error",p=>{console.log(p),m(p)}),n.on("finish",async()=>{try{await o.makePublic();let p=`https://storage.googleapis.com/${this.bucket.name}/${o.name}`;a(p)}catch(p){console.error(p),m(p)}}),n.end(e.buffer)})}async updateFile({file:e,id:t,imageUrl:r,folder:i}){try{let o=this.getPath(r);if(!o)throw new Error("Arquivo n\xE3o encontrado.");let[a,m]=await Promise.all([this.bucket.file(o).delete(),this.uploadFile({file:e,id:t,folder:i})]);return m}catch(o){throw console.error(o),new Error("Erro ao atualizar o arquivo.")}}async deleteFile({imageUrl:e}){let t=this.getPath(e);if(!t)throw new Error("Arquivo n\xE3o encontrado.");try{await this.bucket.file(t).delete()}catch(r){throw console.error(r),new Error("Erro ao deletar o arquivo.")}}getPath(e){let t=e.match(Vt);return t?t[0].slice(1):null}};function k(){return new ne(Le)}function We(){return{createNewsController:new te(b(),k())}}function Ze(){return{findAllNewsController:new ie(b())}}function Je(){return{findNewsByIdController:new oe(b())}}function Ye(){return{findNewsByAuthorIdController:new se(b())}}function Ge(){return{updateNewsController:new ae(b(),k())}}function Ve(){return{deleteNewsController:new re(b(),k())}}import Xe from"multer";var ve=Xe({storage:Xe.memoryStorage()});var B=Xt(),{authMiddleware:_e}=w();B.post("/",(s,e,t)=>{_e.authenticated(s,e,t)},ve.single("image"),async(s,e)=>{let{createNewsController:t}=We();await t.handle(s,e)});B.get("/",async(s,e)=>{let{findAllNewsController:t}=Ze();await t.handle(s,e)});B.get("/:id",async(s,e)=>{let{findNewsByIdController:t}=Je();await t.handle(s,e)});B.get("/author/:authorId",async(s,e)=>{let{findNewsByAuthorIdController:t}=Ye();await t.handle(s,e)});B.put("/:id",(s,e,t)=>{_e.authenticated(s,e,t)},ve.single("image"),async(s,e)=>{let{updateNewsController:t}=Ge();await t.handle(s,e)});B.delete("/:id",(s,e,t)=>{_e.authenticated(s,e,t)},async(s,e)=>{let{deleteNewsController:t}=Ve();await t.handle(s,e)});import{Router as sr}from"express";import C from"zod";var $t=C.object({teamId:C.uuid(),member:C.object({userId:C.uuid(),role:C.string(),description:C.string()})}),me=class{constructor(e,t){this.teamMemberRepository=e;this.userRepository=t}async handle(e,t){try{let r=$t.safeParse({...e.body,teamId:e.params.teamId});if(!r.success)return t.status(400).json({errors:C.prettifyError(r.error)});let{teamId:i,member:{userId:o,...a}}=r.data;if(!await this.userRepository.findById(o))return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let n=await this.teamMemberRepository.create({...a,userId:o,teamId:i});t.status(201).json(n)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Ce}from"zod";var er=Ce.object({id:Ce.uuid()}),pe=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=er.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ce.prettifyError(r.error)});let{id:i}=r.data;await this.teamMemberRepository.delete(i),t.status(200).json({message:"Membro removido com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as je}from"zod";var tr=je.object({id:je.uuid()}),ce=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=tr.safeParse(e.params);if(!r.success)return t.status(400).json({errors:je.prettifyError(r.error)});let{id:i}=r.data,o=await this.teamMemberRepository.findById(i);if(!o)return t.status(404).json({message:"Membro n\xE3o encontrado."});t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as O}from"zod";var rr=O.object({id:O.uuid(),role:O.string(),userId:O.string(),description:O.string()}),ue=class{constructor(e){this.teamMemberRepository=e}async handle(e,t){try{let r=rr.safeParse(e.body);if(!r.success)return t.status(400).json({errors:O.prettifyError(r.error)});let i=r.data,o=await this.teamMemberRepository.update(i);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var U=class{constructor(e){this.prisma=e}async findById(e){return await this.prisma.teamMember.findFirst({where:{id:e}})}async findByTeamId(e){return await this.prisma.teamMember.findMany({where:{teamId:e}})}async create({description:e,role:t,teamId:r,userId:i}){return await this.prisma.teamMember.create({data:{role:t,description:e,teamId:r,userId:i}})}async update({id:e,...t}){return await this.prisma.teamMember.update({where:{id:e},data:t})}async updateMany({members:e,teamId:t}){await Promise.all(e.map(async({user:r,role:i})=>{let o=await this.prisma.teamMember.findFirst({where:{teamId:t,userId:r.id},include:{user:!0}});o?await this.prisma.teamMember.update({where:{id:o.id},data:{role:i}}):await this.prisma.teamMember.create({data:{teamId:t,userId:r.id,role:i}})}))}async delete(e){await this.prisma.teamMember.deleteMany({where:{id:e}})}async deleteMany(e){await Promise.all(e.map(async t=>{await this.prisma.teamMember.delete({where:{id:t}})}))}};function $e(){return{createTeamMemberController:new me(new U(y),h())}}function et(){return{findTeamMemberController:new ce(new U(y))}}function tt(){return{updateTeamMemberController:new ue(new U(y))}}function rt(){return{deleteTeamMemberController:new pe(new U(y))}}var q=sr(),{authMiddleware:de}=w();q.post("/:teamId/member",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{createTeamMemberController:t}=$e();await t.handle(s,e)});q.get("/member/:id",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{findTeamMemberController:t}=et();await t.handle(s,e)});q.put("/member/:id",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamMemberController:t}=tt();await t.handle(s,e)});q.delete("/member/:id",(s,e,t)=>{de.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamMemberController:t}=rt();await t.handle(s,e)});import{Router as pr}from"express";import S from"zod";var or=S.object({name:S.string().min(1),type:S.string().min(1),members:S.array(S.object({role:S.string().min(1),user:S.object({id:S.string()})}))}),le=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=or.safeParse(e.body);if(!r.success)return t.status(400).json({errors:S.prettifyError(r.error)});let{name:i,type:o,members:a}=r.data,m=await this.teamRepository.create({name:i,type:o,members:a});t.status(201).json(m)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Ne}from"zod";var ir=Ne.object({id:Ne.uuid()}),ye=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=ir.safeParse(e.params);if(!r.success)return t.status(400).json({errors:Ne.prettifyError(r.error)});let{id:i}=r.data;await this.teamRepository.delete(i),t.status(200).json({message:"Equipe deletada com sucesso"})}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as xe}from"zod";var ar=xe.object({id:xe.uuid()}),fe=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=ar.safeParse(e.params);if(!r.success)return t.status(400).json({errors:xe.prettifyError(r.error)});let{id:i}=r.data,o=await this.teamRepository.findById(i);t.status(200).json(o)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};import{z as Re}from"zod";var nr=Re.object({type:Re.string(),name:Re.string().optional()}),he=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=nr.safeParse({type:e.params.type,name:e.query.name});if(!r.success)return t.status(400).json({errors:Re.prettifyError?.(r.error)});let{type:i,name:o}=r.data,a=await this.teamRepository.findByType({type:i,filter:{name:o}});t.status(200).json(a)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var we=class{constructor(e){this.teamRepository=e}async handle(e,t){try{let r=await this.teamRepository.findAll();return t.status(200).json(r)}catch(r){if(console.error(r),r instanceof Error)return t.status(400).json({message:r.message})}}};import{z as I}from"zod";var mr=I.object({id:I.uuid(),name:I.string().min(1),members:I.array(I.object({role:I.string(),id:I.uuid(),user:I.object({id:I.uuid()})}))}),ge=class{constructor(e,t){this.teamRepository=e;this.teamMemberRepository=t}async handle(e,t){try{let r=mr.safeParse({id:e.params.id,...e.body});if(!r.success)return t.status(400).json({errors:I.prettifyError(r.error)});let{name:i,members:o,id:a}=r.data,m=await this.teamMemberRepository.findByTeamId(a),n=o.map(l=>l.id),p=m.filter(l=>!n.includes(l.id)).map(l=>l.id);await this.teamMemberRepository.deleteMany(p),await this.teamMemberRepository.updateMany({teamId:a,members:o});let u=await this.teamRepository.update({id:a,name:i});t.status(200).json(u)}catch(r){console.error(r),r instanceof Error&&t.status(400).json({message:r.message})}}};var Ee=class{constructor(e){this.prisma=e}async create({members:e,name:t,type:r}){return await this.prisma.team.create({data:{name:t,type:r,members:{create:e.map(({description:i,role:o,user:a})=>({role:o,description:i,user:{connect:{id:a.id}}}))}}})}async findAll(){return await this.prisma.team.findMany({include:{members:{include:{user:!0}}}})}async findById(e){return await this.prisma.team.findUnique({where:{id:e},include:{members:{include:{user:!0}}}})}async findByType({type:e,filter:{name:t}}){let r={type:e};return t&&(r.name={contains:t,mode:"insensitive"}),await this.prisma.team.findMany({where:r,include:{members:{include:{user:!0}}}})}async update({id:e,name:t}){return await this.prisma.team.update({where:{id:e},data:{name:t}})}async delete(e){await this.prisma.team.delete({where:{id:e}})}};function j(){return new Ee(y)}function st(){return new U(y)}function ot(){return{findTeamsController:new we(j())}}function it(){return{findTeamByIdController:new fe(j())}}function at(){return{findTeamByTypeController:new he(j())}}function nt(){return{createTeamController:new le(j())}}function mt(){return{updateTeamController:new ge(j(),st())}}function pt(){return{deleteTeamController:new ye(j())}}var v=pr(),{authMiddleware:Fe}=w();v.get("/",async(s,e)=>{let{findTeamsController:t}=ot();await t.handle(s,e)});v.get("/id/:id",async(s,e)=>{let{findTeamByIdController:t}=it();await t.handle(s,e)});v.get("/type/:type",async(s,e)=>{let{findTeamByTypeController:t}=at();await t.handle(s,e)});v.post("/",(s,e,t)=>{Fe.isAdmin(s,e,t)},async(s,e)=>{let{createTeamController:t}=nt();await t.handle(s,e)});v.put("/:id",(s,e,t)=>{Fe.isAdmin(s,e,t)},async(s,e)=>{let{updateTeamController:t}=mt();await t.handle(s,e)});v.delete("/:id",(s,e,t)=>{Fe.isAdmin(s,e,t)},async(s,e)=>{let{deleteTeamController:t}=pt();await t.handle(s,e)});import{Router as fr}from"express";import ct from"zod";var cr=ct.object({id:ct.string()}),Ie=class{constructor(e){this.userRepository=e}async handle(e,t){try{let{id:r}=cr.parse(e.body),i=await this.userRepository.findById(r);if(!i)return t.status(404).json({message:"O usu\xE1rio n\xE3o existe."});let o=e.user.id;return i.id!==o?t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para deletar o usu\xE1rio"}):(await this.userRepository.deleteById(i.id),t.status(200).json({message:"Usu\xE1rio deletado com sucesso!"}))}catch(r){r instanceof Error&&t.status(400).json({message:r.message})}}};var Te=class{constructor(e){this.userRepository=e}async handle(e,t){try{let r=await this.userRepository.find();t.status(200).json(r)}catch(r){console.log(r),r instanceof Error&&t.status(400).json({message:"Erro ao buscar usu\xE1rios"})}}};import{UserRole as dt}from"@prisma/client";import N from"zod";var ur=5,ut=1024,dr=ut*ut,lr=ur*dr,yr=N.object({id:N.uuid(),name:N.string().optional(),password:N.string().optional(),role:N.enum(dt).optional(),avatarImage:N.any().optional().refine(s=>!s||typeof s=="object"&&typeof s.mimetype=="string"&&s.mimetype.startsWith("image/")&&typeof s.size=="number"&&s.size<=lr,{message:"O avatar deve ser uma imagem v\xE1lida de no m\xE1ximo 5MB."}).optional()}),be=class{constructor(e,t,r){this.userRepository=e;this.firebaseStorageService=t;this.bcryptService=r}async handle(e,t){try{let r=yr.safeParse({...e.body,avatarImage:e.file});if(!r.success)return t.status(400).json({errors:N.prettifyError(r.error)});let{id:i,name:o,role:a,password:m,avatarImage:n}=r.data;if(e.user.id!==i)return t.status(401).json({message:"Voc\xEA n\xE3o tem permiss\xE3o para atualizar o usu\xE1rio."});let u;m&&(u=await this.bcryptService.hash(m));let l;n&&(l=await this.firebaseStorageService.uploadFile({file:n,id:i,folder:M.USER}));let _=e.user.role,A;return _===dt.ADMIN&&(A=a),await this.userRepository.update({avatarUrl:l,id:i,name:o,passwordHash:u,role:A}),t.status(200).json({message:"Usu\xE1rio atualizado com sucesso."})}catch(r){if(console.log(r),r instanceof Error)return t.status(400).json({message:r.message})}}};function lt(){return{updateUserController:new be(h(),k(),P())}}function yt(){return{deleteUserController:new Ie(h())}}function ft(){return{findUsersController:new Te(h())}}var H=fr(),{authMiddleware:Rt}=w();H.put("/",(s,e,t)=>{Rt.authenticated(s,e,t)},async(s,e)=>{let{updateUserController:t}=lt();await t.handle(s,e)});H.delete("/",(s,e,t)=>{Rt.authenticated(s,e,t)},async(s,e)=>{let{deleteUserController:t}=yt();await t.handle(s,e)});H.get("/",async(s,e)=>{let{findUsersController:t}=ft();await t.handle(s,e)});var R=Me(),hr={methods:["GET","POST","PUT","DELETE"],origin:["http://localhost:3000","https://rede-ct.vercel.app"],credentials:!0};R.use(Rr(hr));R.use(Me.json());R.use(Me.urlencoded({extended:!1}));R.use("/",Ue);R.use("/auth",F);R.use("/user",H);R.use("/news",B);R.use("/team",v);R.use("/team",q);var gr=wr.createServer(R),ht=4e3;gr.listen(ht,()=>{console.log(`\u{1F680} Aplica\xE7\xE3o rodando na porta ${ht}.`)});
